name: ci-cd-main

on:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: ci-cd-main
  cancel-in-progress: true

jobs:
  backend-ci:
    name: Backend CI
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend/core
    env:
      SECRET_KEY: ci-secret-key
      DEBUG: "False"
      DATABASE_ENGINE: django.db.backends.sqlite3
      SQLITE_NAME: /tmp/mks-ci.sqlite3
      ALLOWED_HOSTS: localhost,127.0.0.1,testserver
      TENANT_PUBLIC_HOSTS: localhost,127.0.0.1,testserver
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"
          cache-dependency-path: backend/core/requirements/base.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements/base.txt

      - name: Django check
        run: python manage.py check

      - name: Backend tests
        run: python manage.py test

  frontend-ci:
    name: Frontend CI
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend/mks-ui
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: frontend/mks-ui/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Frontend build
        run: npm run build

  deploy:
    name: Deploy Cloud Run
    runs-on: ubuntu-latest
    needs:
      - backend-ci
      - frontend-ci
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: read
      id-token: write
    env:
      PROJECT_ID: ${{ vars.GCP_PROJECT_ID || 'mks-saas-enterprise-py' }}
      REGION: ${{ vars.GCP_REGION || 'us-central1' }}
      CLOUD_RUN_SERVICE: ${{ vars.CLOUD_RUN_SERVICE || 'mks-backend' }}
      CLOUD_RUN_FRONTEND_SERVICE: ${{ vars.CLOUD_RUN_FRONTEND_SERVICE || 'mks-frontend' }}
      CLOUD_RUN_MIGRATION_JOB: ${{ vars.CLOUD_RUN_MIGRATION_JOB || 'mks-backend' }}
      ARTIFACT_REPOSITORY: ${{ vars.ARTIFACT_REGISTRY_REPOSITORY || 'mks-backend' }}
      IMAGE_NAME: ${{ vars.BACKEND_IMAGE_NAME || 'mks-backend' }}
      FRONTEND_IMAGE_NAME: ${{ vars.FRONTEND_IMAGE_NAME || 'mks-frontend' }}
      CLOUD_SQL_INSTANCE: ${{ vars.CLOUD_SQL_INSTANCE || 'mks-db-instance' }}
      CLOUD_STORAGE_BUCKET: ${{ vars.CLOUD_STORAGE_BUCKET || 'mks-storage-mks-saas-enterprise-py' }}
      DATABASE_NAME: ${{ vars.DATABASE_NAME || 'mks_db' }}
      DATABASE_USER: ${{ vars.DATABASE_USER || 'mks_user' }}
      TENANT_BASE_DOMAIN: ${{ vars.TENANT_BASE_DOMAIN || 'mksbrasil.com' }}
      CONTROL_PLANE_SUBDOMAIN: ${{ vars.CONTROL_PLANE_SUBDOMAIN || 'sistema' }}
      DJANGO_SECRET_KEY_SECRET_NAME: ${{ vars.DJANGO_SECRET_KEY_SECRET_NAME || 'django-secret-key' }}
      DB_PASSWORD_SECRET_NAME: ${{ vars.DB_PASSWORD_SECRET_NAME || 'mks-db-password' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Assert GCP auth variables
        run: |
          test -n "${{ vars.GCP_WORKLOAD_IDENTITY_PROVIDER }}" || (echo "Missing repo var GCP_WORKLOAD_IDENTITY_PROVIDER" && exit 1)
          test -n "${{ vars.GCP_SERVICE_ACCOUNT }}" || (echo "Missing repo var GCP_SERVICE_ACCOUNT" && exit 1)

      - name: Authenticate to GCP (Workload Identity)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ vars.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ vars.GCP_SERVICE_ACCOUNT }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Enable required APIs
        run: |
          gcloud services enable \
            run.googleapis.com \
            cloudbuild.googleapis.com \
            artifactregistry.googleapis.com \
            sqladmin.googleapis.com \
            secretmanager.googleapis.com \
            aiplatform.googleapis.com \
            iamcredentials.googleapis.com

      - name: Ensure Artifact Registry repository
        run: |
          gcloud artifacts repositories describe "$ARTIFACT_REPOSITORY" \
            --location "$REGION" >/dev/null 2>&1 || \
          gcloud artifacts repositories create "$ARTIFACT_REPOSITORY" \
            --repository-format=docker \
            --location="$REGION" \
            --description="MKS SaaS backend images"

      - name: Configure Docker auth for Artifact Registry
        run: gcloud auth configure-docker "${REGION}-docker.pkg.dev" --quiet

      - name: Build and push image
        run: |
          IMAGE_URI="${REGION}-docker.pkg.dev/${PROJECT_ID}/${ARTIFACT_REPOSITORY}/${IMAGE_NAME}:${GITHUB_SHA}"
          docker build -t "${IMAGE_URI}" backend/core
          docker push "${IMAGE_URI}"
          echo "IMAGE_URI=${IMAGE_URI}" >> "$GITHUB_ENV"
          FRONTEND_IMAGE_URI="${REGION}-docker.pkg.dev/${PROJECT_ID}/${ARTIFACT_REPOSITORY}/${FRONTEND_IMAGE_NAME}:${GITHUB_SHA}"
          docker build -t "${FRONTEND_IMAGE_URI}" frontend/mks-ui
          docker push "${FRONTEND_IMAGE_URI}"
          echo "FRONTEND_IMAGE_URI=${FRONTEND_IMAGE_URI}" >> "$GITHUB_ENV"

      - name: Run migrations via Cloud Run Job
        run: |
          INSTANCE_CONNECTION_NAME="${PROJECT_ID}:${REGION}:${CLOUD_SQL_INSTANCE}"
          CONTROL_PLANE_HOST="${CONTROL_PLANE_SUBDOMAIN}.${TENANT_BASE_DOMAIN}"
          ENV_VARS="^|^DEBUG=False|ALLOWED_HOSTS=.run.app,.${TENANT_BASE_DOMAIN},${TENANT_BASE_DOMAIN}|GOOGLE_CLOUD_PROJECT=${PROJECT_ID}|VERTEX_AI_PROJECT_ID=${PROJECT_ID}|VERTEX_AI_LOCATION=${REGION}|TENANT_BASE_DOMAIN=${TENANT_BASE_DOMAIN}|CONTROL_PLANE_SUBDOMAIN=${CONTROL_PLANE_SUBDOMAIN}|CONTROL_PLANE_HOST=${CONTROL_PLANE_HOST}|CLOUD_SQL_INSTANCE=${INSTANCE_CONNECTION_NAME}|DATABASE_ENGINE=django.db.backends.postgresql|DATABASE_NAME=${DATABASE_NAME}|DATABASE_USER=${DATABASE_USER}|CLOUD_STORAGE_BUCKET=${CLOUD_STORAGE_BUCKET}"
          SECRET_VARS="SECRET_KEY=${DJANGO_SECRET_KEY_SECRET_NAME}:latest,DATABASE_PASSWORD=${DB_PASSWORD_SECRET_NAME}:latest"

          if gcloud run jobs describe "${CLOUD_RUN_MIGRATION_JOB}" --region "${REGION}" >/dev/null 2>&1; then
            gcloud run jobs update "${CLOUD_RUN_MIGRATION_JOB}" \
              --image "${IMAGE_URI}" \
              --region "${REGION}" \
              --command python \
              --args manage.py,migrate,--noinput \
              --set-cloudsql-instances "${INSTANCE_CONNECTION_NAME}" \
              --set-env-vars "${ENV_VARS}" \
              --set-secrets "${SECRET_VARS}" \
              --tasks 1 \
              --max-retries 1 \
              --task-timeout 900s
          else
            gcloud run jobs create "${CLOUD_RUN_MIGRATION_JOB}" \
              --image "${IMAGE_URI}" \
              --region "${REGION}" \
              --command python \
              --args manage.py,migrate,--noinput \
              --set-cloudsql-instances "${INSTANCE_CONNECTION_NAME}" \
              --set-env-vars "${ENV_VARS}" \
              --set-secrets "${SECRET_VARS}" \
              --tasks 1 \
              --max-retries 1 \
              --task-timeout 900s
          fi

          gcloud run jobs execute "${CLOUD_RUN_MIGRATION_JOB}" --region "${REGION}" --wait

      - name: Deploy backend service
        id: deploy
        run: |
          INSTANCE_CONNECTION_NAME="${PROJECT_ID}:${REGION}:${CLOUD_SQL_INSTANCE}"
          CONTROL_PLANE_HOST="${CONTROL_PLANE_SUBDOMAIN}.${TENANT_BASE_DOMAIN}"
          ENV_VARS="^|^DEBUG=False|ALLOWED_HOSTS=.run.app,.${TENANT_BASE_DOMAIN},${TENANT_BASE_DOMAIN}|GOOGLE_CLOUD_PROJECT=${PROJECT_ID}|VERTEX_AI_PROJECT_ID=${PROJECT_ID}|VERTEX_AI_LOCATION=${REGION}|TENANT_BASE_DOMAIN=${TENANT_BASE_DOMAIN}|CONTROL_PLANE_SUBDOMAIN=${CONTROL_PLANE_SUBDOMAIN}|CONTROL_PLANE_HOST=${CONTROL_PLANE_HOST}|CLOUD_SQL_INSTANCE=${INSTANCE_CONNECTION_NAME}|DATABASE_ENGINE=django.db.backends.postgresql|DATABASE_NAME=${DATABASE_NAME}|DATABASE_USER=${DATABASE_USER}|CLOUD_STORAGE_BUCKET=${CLOUD_STORAGE_BUCKET}"
          SECRET_VARS="SECRET_KEY=${DJANGO_SECRET_KEY_SECRET_NAME}:latest,DATABASE_PASSWORD=${DB_PASSWORD_SECRET_NAME}:latest"

          gcloud run deploy "${CLOUD_RUN_SERVICE}" \
            --image "${IMAGE_URI}" \
            --region "${REGION}" \
            --platform managed \
            --allow-unauthenticated \
            --port 8000 \
            --set-cloudsql-instances "${INSTANCE_CONNECTION_NAME}" \
            --set-env-vars "${ENV_VARS}" \
            --set-secrets "${SECRET_VARS}"

          SERVICE_URL="$(gcloud run services describe "${CLOUD_RUN_SERVICE}" --region "${REGION}" --format='value(status.url)')"
          echo "service_url=${SERVICE_URL}" >> "$GITHUB_OUTPUT"

      - name: Deploy frontend service
        id: deploy_frontend
        run: |
          gcloud run deploy "${CLOUD_RUN_FRONTEND_SERVICE}" \
            --image "${FRONTEND_IMAGE_URI}" \
            --region "${REGION}" \
            --platform managed \
            --allow-unauthenticated \
            --port 8080

          FRONTEND_URL="$(gcloud run services describe "${CLOUD_RUN_FRONTEND_SERVICE}" --region "${REGION}" --format='value(status.url)')"
          echo "frontend_url=${FRONTEND_URL}" >> "$GITHUB_OUTPUT"

      - name: Deployment summary
        run: |
          {
            echo "## Cloud Run Deploy"
            echo "- Service: \`${CLOUD_RUN_SERVICE}\`"
            echo "- Region: \`${REGION}\`"
            echo "- Project: \`${PROJECT_ID}\`"
            echo "- Image: \`${IMAGE_URI}\`"
            echo "- URL: ${{ steps.deploy.outputs.service_url }}"
            echo ""
            echo "## Frontend Deploy"
            echo "- Service: \`${CLOUD_RUN_FRONTEND_SERVICE}\`"
            echo "- Image: \`${FRONTEND_IMAGE_URI}\`"
            echo "- URL: ${{ steps.deploy_frontend.outputs.frontend_url }}"
          } >> "$GITHUB_STEP_SUMMARY"
