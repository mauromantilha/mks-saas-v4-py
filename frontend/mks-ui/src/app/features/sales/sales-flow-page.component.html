<section class="sales-wrap">
  <div class="header-section">
    <div class="title-group">
      <h1><i class="pi pi-chart-line"></i> Fluxo Comercial</h1>
      <p class="subtitle">Gestão completa do processo de vendas</p>
    </div>

    <div *ngIf="session()" class="user-badge">
      <i class="pi pi-user"></i>
      <div class="user-info">
        <span class="user-name">{{ session()?.username }}</span>
        <span class="user-role">{{ session()?.role }} · {{ session()?.tenantCode }}</span>
      </div>
    </div>
  </div>

  <div class="toolbar-actions">
    <button pButton 
      label="Atualizar Painel" 
      icon="pi pi-refresh" 
      (click)="load()" 
      [loading]="loading()"
      severity="secondary"></button>
  </div>

  <p-message *ngIf="loading()" severity="info" text="Carregando dados do painel..."></p-message>
  <p-message *ngIf="error()" severity="error" [text]="error()"></p-message>
  <p-message *ngIf="notice()" severity="success" [text]="notice()"></p-message>

  <p-card styleClass="card metrics-card" *ngIf="metrics() as m">
    <h2>Visão Comercial Prioritária</h2>
    <p class="filters-summary">
      Período: {{ m.period.from_date || "início" }} até {{ m.period.to_date || "hoje" }}
    </p>
    <div class="metrics-grid">
      <div class="metric-item">
        <span class="metric-label">Leads Novos</span>
        <strong class="metric-value">{{ m.lead_funnel.NEW }}</strong>
      </div>
      <div class="metric-item">
        <span class="metric-label">Leads Qualificados</span>
        <strong class="metric-value">{{ m.lead_funnel.QUALIFIED }}</strong>
      </div>
      <div class="metric-item">
        <span class="metric-label">Leads Convertidos</span>
        <strong class="metric-value">{{ m.lead_funnel.CONVERTED }}</strong>
      </div>
      <div class="metric-item">
        <span class="metric-label">Oportunidades Ganhas</span>
        <strong class="metric-value">{{ m.opportunity_funnel.WON }}</strong>
      </div>
      <div class="metric-item">
        <span class="metric-label">Taxa de Fechamento</span>
        <strong class="metric-value">{{ m.conversion.opportunity_win_rate | number: "1.0-2" }}%</strong>
      </div>
      <div class="metric-item">
        <span class="metric-label">Pipeline Aberto</span>
        <strong class="metric-value">{{ formatCurrency(m.pipeline_value.open_total_amount) }}</strong>
      </div>
      <div class="metric-item">
        <span class="metric-label">Previsto 30 dias</span>
        <strong class="metric-value">{{ formatCurrency(m.pipeline_value.expected_close_next_30d_amount) }}</strong>
      </div>
      <div class="metric-item">
        <span class="metric-label">Atividades Atrasadas</span>
        <strong class="metric-value">{{ m.activities.overdue_total }}</strong>
      </div>
    </div>
  </p-card>

  <div class="grid">
    <p-card styleClass="card">
      <h2>Entrada Comercial (Lead/Prospect)</h2>
      <p class="hint">
        Cadastro único de entrada. O cliente é criado automaticamente na conversão do lead.
      </p>
      <div class="form-grid">
        <label>
          Origem *
          <input pInputText
            type="text"
            [ngModel]="leadSource()"
            (ngModelChange)="leadSource.set($event)"
            [disabled]="loading() || !canWrite()"
            placeholder="Site, indicação, campanha..."
          />
        </label>
        <label>
          Nome do contato
          <input pInputText
            type="text"
            [ngModel]="leadFullName()"
            (ngModelChange)="leadFullName.set($event)"
            [disabled]="loading() || !canWrite()"
          />
        </label>
        <label>
          Empresa
          <input pInputText
            type="text"
            [ngModel]="leadCompanyName()"
            (ngModelChange)="leadCompanyName.set($event)"
            [disabled]="loading() || !canWrite()"
          />
        </label>
        <label>
          E-mail
          <input pInputText
            type="email"
            [ngModel]="leadEmail()"
            (ngModelChange)="leadEmail.set($event)"
            [disabled]="loading() || !canWrite()"
          />
        </label>
        <label>
          Telefone
          <input pInputText
            type="text"
            [ngModel]="leadPhone()"
            (ngModelChange)="leadPhone.set($event)"
            [disabled]="loading() || !canWrite()"
          />
        </label>
        <label>
          CNPJ
          <input pInputText
            type="text"
            [ngModel]="leadCnpj()"
            (ngModelChange)="leadCnpj.set($event)"
            [disabled]="loading() || !canWrite()"
            placeholder="00.000.000/0001-00"
          />
        </label>
        <label>
          Produtos de interesse
          <input pInputText
            type="text"
            [ngModel]="leadProductsOfInterest()"
            (ngModelChange)="leadProductsOfInterest.set($event)"
            [disabled]="loading() || !canWrite()"
            placeholder="Auto, Vida, Empresarial..."
          />
        </label>
        <label>
          Orçamento estimado
          <input pInputText
            type="number"
            [ngModel]="leadEstimatedBudget()"
            (ngModelChange)="leadEstimatedBudget.set($event)"
            [disabled]="loading() || !canWrite()"
          />
        </label>
        <label class="field-full">
          Observações
          <textarea pInputTextarea
            rows="2"
            [ngModel]="leadNotes()"
            (ngModelChange)="leadNotes.set($event)"
            [disabled]="loading() || !canWrite()"
          ></textarea>
        </label>
      </div>
      <div class="actions top-gap">
        <button pButton type="button" (click)="createLead()" [disabled]="loading() || !canWrite()">
          Criar lead
        </button>
      </div>
    </p-card>

    <p-card styleClass="card activity-card">
      <ng-template pTemplate="header">
        <div class="card-header-custom">
          <i class="pi pi-calendar-plus"></i>
          <h2>Criar Atividade / Agenda</h2>
        </div>
      </ng-template>
      <p class="card-description">
        <i class="pi pi-info-circle"></i> 
        Crie tarefas, follow-ups e lembretes vinculados a leads ou oportunidades
      </p>
      <div class="form-grid">
        <div class="field">
          <label for="activityKind">Tipo de Atividade *</label>
          <p-select
            inputId="activityKind"
            [options]="activityKindOptions"
            optionLabel="label"
            optionValue="value"
            [ngModel]="activityKind()"
            (ngModelChange)="activityKind.set($event)"
            [disabled]="loading() || !canWrite()"
            placeholder="Escolha o tipo"
            styleClass="w-full"
          >
            <ng-template pTemplate="selectedItem" let-option>
              <div class="flex align-items-center gap-2" *ngIf="option">
                <i class="pi" [ngClass]="{
                  'pi-check-square': option.value === 'TASK',
                  'pi-phone': option.value === 'FOLLOW_UP',
                  'pi-file-edit': option.value === 'NOTE'
                }"></i>
                <span>{{ option.label }}</span>
              </div>
            </ng-template>
            <ng-template pTemplate="item" let-option>
              <div class="flex align-items-center gap-2">
                <i class="pi" [ngClass]="{
                  'pi-check-square': option.value === 'TASK',
                  'pi-phone': option.value === 'FOLLOW_UP',
                  'pi-file-edit': option.value === 'NOTE'
                }"></i>
                <span>{{ option.label }}</span>
              </div>
            </ng-template>
          </p-select>
        </div>
        <div class="field">
          <label for="activityPriority">Prioridade *</label>
          <p-select
            inputId="activityPriority"
            [options]="activityPriorityOptions"
            optionLabel="label"
            optionValue="value"
            [ngModel]="activityPriority()"
            (ngModelChange)="activityPriority.set($event)"
            [disabled]="loading() || !canWrite()"
            placeholder="Escolha a prioridade"
            styleClass="w-full"
          >
            <ng-template pTemplate="selectedItem" let-option>
              <div class="flex align-items-center gap-2" *ngIf="option">
                <i class="pi pi-circle-fill" [style.color]="getPriorityColor(option.value)"></i>
                <span>{{ option.label }}</span>
              </div>
            </ng-template>
            <ng-template pTemplate="item" let-option>
              <div class="flex align-items-center gap-2">
                <i class="pi pi-circle-fill" [style.color]="getPriorityColor(option.value)"></i>
                <span>{{ option.label }}</span>
              </div>
            </ng-template>
          </p-select>
        </div>
        <div class="field field-full">
          <label for="activityTitle">Título da Atividade *</label>
          <input pInputText
            id="activityTitle"
            type="text"
            [ngModel]="activityTitle()"
            (ngModelChange)="activityTitle.set($event)"
            [disabled]="loading() || !canWrite()"
            placeholder="Ex.: Follow-up proposta renovação"
            class="w-full"
          />
        </div>
        <div class="field">
          <label for="activityTargetType">Vincular a *</label>
          <p-select
            inputId="activityTargetType"
            [options]="activityTargetTypeOptions"
            optionLabel="label"
            optionValue="value"
            [ngModel]="activityTargetType()"
            (ngModelChange)="onActivityTargetTypeChange($event)"
            [disabled]="loading() || !canWrite()"
            placeholder="Escolha o vínculo"
            styleClass="w-full"
          ></p-select>
        </div>
        <div class="field">
          <label for="activityTargetId">Registro *</label>
          <p-select
            inputId="activityTargetId"
            *ngIf="activityTargetType() === 'LEAD'"
            [options]="leadTargetOptions()"
            [ngModel]="activityTargetId()"
            (ngModelChange)="activityTargetId.set($event)"
            [disabled]="loading() || !canWrite()"
            placeholder="Selecione um lead"
            [filter]="true"
            filterBy="label"
            styleClass="w-full"
          ></p-select>
          <p-select
            inputId="activityTargetId"
            *ngIf="activityTargetType() === 'OPPORTUNITY'"
            [options]="opportunityTargetOptions()"
            [ngModel]="activityTargetId()"
            (ngModelChange)="activityTargetId.set($event)"
            [disabled]="loading() || !canWrite()"
            placeholder="Selecione uma oportunidade"
            [filter]="true"
            filterBy="label"
            styleClass="w-full"
          ></p-select>
        </div>
        <div class="field">
          <label for="activityDueAt">
            <i class="pi pi-calendar"></i> Data/Hora Vencimento
          </label>
          <input pInputText
            id="activityDueAt"
            type="datetime-local"
            [ngModel]="activityDueAt()"
            (ngModelChange)="activityDueAt.set($event)"
            [disabled]="loading() || !canWrite()"
            class="w-full"
          />
        </div>
        <div class="field">
          <label for="activityReminderAt">
            <i class="pi pi-bell"></i> Data/Hora Lembrete
          </label>
          <input pInputText
            id="activityReminderAt"
            type="datetime-local"
            [ngModel]="activityReminderAt()"
            (ngModelChange)="activityReminderAt.set($event)"
            [disabled]="loading() || !canWrite()"
            class="w-full"
          />
        </div>
        <div class="field">
          <label for="activitySlaHours">
            <i class="pi pi-clock"></i> SLA (horas)
          </label>
          <input pInputText
            id="activitySlaHours"
            type="number"
            min="1"
            [ngModel]="activitySlaHours()"
            (ngModelChange)="activitySlaHours.set($event)"
            [disabled]="loading() || !canWrite()"
            placeholder="24"
            class="w-full"
          />
        </div>
      </div>
      <div class="actions-footer">
        <button pButton 
          label="Criar Atividade" 
          icon="pi pi-plus" 
          (click)="createActivity()" 
          [disabled]="loading() || !canWrite()"
          severity="success"></button>
      </div>
    </p-card>
  </div>

  <div class="grid secondary-grid">
    <p-card styleClass="card">
      <h2>Leads</h2>
      <p-table *ngIf="leads().length > 0" class="table" [value]="leads()" responsiveLayout="scroll">
        <ng-template pTemplate="header">
          <tr>
            <th>ID</th>
            <th>Origem</th>
            <th>Empresa</th>
            <th>Status</th>
            <th>CNPJ</th>
            <th>Ações</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-lead>
          <tr>
            <td>{{ lead.id }}</td>
            <td>{{ lead.source }}</td>
            <td>{{ lead.company_name || "-" }}</td>
            <td>{{ lead.status }}</td>
            <td>{{ lead.cnpj || "-" }}</td>
            <td>
              <div class="actions">
                <button pButton type="button" (click)="qualifyLead(lead)" [disabled]="loading() || !canWrite() || lead.status !== 'NEW'">Qualificar</button>
                <button pButton type="button" (click)="convertLead(lead)" [disabled]="loading() || !canWrite() || lead.status !== 'QUALIFIED'">Converter</button>
                <button pButton type="button" (click)="generateLeadInsights(lead)" [disabled]="loading() || !canWrite()">Insights IA</button>
                <button pButton type="button" (click)="enrichLeadCnpj(lead)" [disabled]="loading() || !canWrite()">Enriquecer CNPJ</button>
              </div>
            </td>
          </tr>
        </ng-template>
      </p-table>
      <p *ngIf="leads().length === 0">Nenhum lead encontrado.</p>
    </p-card>

    <p-card styleClass="card">
      <h2>Oportunidades</h2>
      <p-table *ngIf="opportunities().length > 0" class="table" [value]="opportunities()" responsiveLayout="scroll">
        <ng-template pTemplate="header">
          <tr>
            <th>ID</th>
            <th>Título</th>
            <th>Estágio</th>
            <th>Valor</th>
            <th>Probabilidade</th>
            <th>Ações</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-opp>
          <tr>
            <td>{{ opp.id }}</td>
            <td>{{ opp.title }}</td>
            <td>{{ opp.stage }}</td>
            <td>{{ opp.amount }}</td>
            <td>{{ opp.closing_probability }}%</td>
            <td>
              <div class="actions">
                <button pButton type="button" (click)="moveToNextStage(opp)" [disabled]="loading() || !canWrite()">Próximo estágio</button>
                <button pButton type="button" (click)="markLost(opp)" [disabled]="loading() || !canWrite() || opp.stage === 'LOST'">Perdida</button>
                <button pButton type="button" (click)="generateOpportunityInsights(opp)" [disabled]="loading() || !canWrite()">Insights IA</button>
              </div>
            </td>
          </tr>
        </ng-template>
      </p-table>
      <p *ngIf="opportunities().length === 0">Nenhuma oportunidade encontrada.</p>
    </p-card>
  </div>

  <!-- Lista de Atividades e Agenda -->
  <div class="activity-agenda-section">
    <p-card styleClass="card list-card">
      <ng-template pTemplate="header">
        <div class="card-header-custom">
          <i class="pi pi-list-check"></i>
          <h2>Minhas Atividades</h2>
          <p-tag [value]="activities().length.toString()" severity="info"></p-tag>
        </div>
      </ng-template>
      
      <p-dataView *ngIf="activities().length > 0" 
        [value]="activities()" 
        layout="list"
        [paginator]="true"
        [rows]="10">
        <ng-template pTemplate="list" let-activity>
          <div class="activity-item" [class.activity-done]="activity.status === 'DONE'"
               [class.activity-overdue]="activity.is_sla_breached && activity.status !== 'DONE'">
            <div class="activity-header">
              <div class="activity-info">
                <i class="pi" [ngClass]="{
                  'pi-check-circle': activity.status === 'DONE',
                  'pi-clock': activity.status === 'PENDING',
                  'pi-exclamation-triangle': activity.is_sla_breached
                }" [style.color]="activity.status === 'DONE' ? '#16a34a' : activity.is_sla_breached ? '#dc2626' : '#f59e0b'"></i>
                <h3 class="activity-title">{{ activity.title }}</h3>
                <p-tag [value]="activity.kind" [severity]="getActivityKindSeverity(activity.kind)"></p-tag>
                <p-tag [value]="activity.priority" 
                       [style]="{'background-color': getPriorityColor(activity.priority)}"></p-tag>
              </div>
              <div class="activity-actions">
                <button pButton 
                  icon="pi pi-check" 
                  label="Concluir"
                  (click)="completeActivity(activity)" 
                  [disabled]="loading() || !canWrite() || activity.status === 'DONE'"
                  size="small"
                  severity="success"></button>
                <button pButton 
                  icon="pi pi-replay" 
                  label="Reabrir"
                  (click)="reopenActivity(activity)" 
                  [disabled]="loading() || !canWrite() || activity.status !== 'DONE'"
                  size="small"
                  severity="secondary"></button>
              </div>
            </div>
            <div class="activity-details">
              <div class="detail-item">
                <i class="pi pi-tag"></i>
                <span>ID: #{{ activity.id }}</span>
              </div>
              <div class="detail-item" *ngIf="activity.lead">
                <i class="pi pi-user"></i>
                <span>Lead #{{ activity.lead }}</span>
              </div>
              <div class="detail-item" *ngIf="activity.opportunity">
                <i class="pi pi-briefcase"></i>
                <span>Oportunidade #{{ activity.opportunity }}</span>
              </div>
              <div class="detail-item" *ngIf="activity.due_at">
                <i class="pi pi-calendar"></i>
                <span>Vencimento: {{ activity.due_at | date: 'dd/MM/yyyy HH:mm' }}</span>
              </div>
              <div class="detail-item" *ngIf="activity.sla_due_at">
                <i class="pi pi-clock"></i>
                <span [class.text-danger]="activity.is_sla_breached">SLA: {{ activity.sla_due_at }}</span>
              </div>
            </div>
            <p class="activity-description" *ngIf="activity.description">
              {{ activity.description }}
            </p>
          </div>
        </ng-template>
      </p-dataView>
      
      <div class="empty-state" *ngIf="activities().length === 0">
        <i class="pi pi-inbox" style="font-size: 3rem; color: var(--mks-muted);"></i>
        <p>Nenhuma atividade cadastrada</p>
        <small>Crie sua primeira atividade usando o formulário acima</small>
      </div>
    </p-card>

    <p-card styleClass="card list-card">
      <ng-template pTemplate="header">
        <div class="card-header-custom">
          <i class="pi pi-bell"></i>
          <h2>Agenda de Lembretes</h2>
          <p-tag [value]="reminderActivities().length.toString()" 
                 [severity]="reminderActivities().length > 0 ? 'warning' : 'success'"></p-tag>
        </div>
      </ng-template>
      
      <p-dataView *ngIf="reminderActivities().length > 0" 
        [value]="reminderActivities()" 
        layout="list"
        [paginator]="true"
        [rows]="10">
        <ng-template pTemplate="list" let-activity>
          <div class="reminder-item" [class.reminder-sent]="activity.reminder_sent">
            <div class="reminder-header">
              <div class="reminder-info">
                <i class="pi pi-bell" [style.color]="activity.reminder_sent ? '#16a34a' : '#f59e0b'"></i>
                <h3 class="reminder-title">{{ activity.title }}</h3>
                <p-tag *ngIf="activity.reminder_sent" value="Enviado" severity="success"></p-tag>
                <p-tag *ngIf="!activity.reminder_sent" value="Pendente" severity="warning"></p-tag>
              </div>
              <button pButton 
                icon="pi pi-check" 
                label="Marcar como Enviado"
                (click)="markReminderSent(activity)" 
                [disabled]="loading() || !canWrite() || activity.reminder_sent"
                size="small"
                severity="success"></button>
            </div>
            <div class="reminder-details">
              <div class="detail-item">
                <i class="pi pi-calendar"></i>
                <span>Lembrete agendado: {{ activity.reminder_at | date: 'dd/MM/yyyy HH:mm' }}</span>
              </div>
              <div class="detail-item">
                <i class="pi pi-tag"></i>
                <span>Atividade ID: #{{ activity.id }}</span>
              </div>
            </div>
          </div>
        </ng-template>
      </p-dataView>
      
      <div class="empty-state" *ngIf="reminderActivities().length === 0">
        <i class="pi pi-check-circle" style="font-size: 3rem; color: #16a34a;"></i>
        <p>Nenhum lembrete pendente</p>
        <small>Todos os lembretes foram processados</small>
      </div>
    </p-card>
  </div>
</section>
