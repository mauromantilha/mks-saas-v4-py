<section class="sales-wrap">
  <h1>Fluxo Comercial</h1>

  <div *ngIf="session()" class="meta">
    <span><strong>Tenant:</strong> {{ session()?.tenantCode }}</span>
    <span><strong>Usuário:</strong> {{ session()?.username }}</span>
    <span><strong>Role:</strong> {{ session()?.role }}</span>
  </div>

  <div class="toolbar">
    <button type="button" (click)="load()" [disabled]="loading()">Atualizar</button>
  </div>

  <p *ngIf="loading()">Carregando...</p>
  <p *ngIf="error()" class="error">{{ error() }}</p>

  <div class="grid">
    <article class="card">
      <h2>Leads</h2>
      <table *ngIf="leads().length > 0" class="table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Source</th>
            <th>Status</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let lead of leads()">
            <td>{{ lead.id }}</td>
            <td>{{ lead.source }}</td>
            <td>{{ lead.status }}</td>
            <td>
              <div class="actions">
                <button
                  type="button"
                  (click)="qualifyLead(lead)"
                  [disabled]="loading() || !canWrite() || lead.status !== 'NEW'"
                >
                  Qualificar
                </button>
                <button
                  type="button"
                  (click)="disqualifyLead(lead)"
                  [disabled]="loading() || !canWrite() || lead.status === 'CONVERTED'"
                >
                  Desqualificar
                </button>
                <button
                  type="button"
                  (click)="convertLead(lead)"
                  [disabled]="loading() || !canWrite() || lead.status !== 'QUALIFIED'"
                >
                  Converter
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
      <p *ngIf="leads().length === 0">Nenhum lead encontrado.</p>
    </article>

    <article class="card">
      <h2>Oportunidades</h2>
      <table *ngIf="opportunities().length > 0" class="table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Título</th>
            <th>Estágio</th>
            <th>Valor</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let opp of opportunities()">
            <td>{{ opp.id }}</td>
            <td>{{ opp.title }}</td>
            <td>{{ opp.stage }}</td>
            <td>{{ opp.amount }}</td>
            <td>
              <div class="actions">
                <button
                  type="button"
                  (click)="moveToNextStage(opp)"
                  [disabled]="loading() || !canWrite()"
                >
                  Próximo estágio
                </button>
                <button
                  type="button"
                  (click)="markLost(opp)"
                  [disabled]="loading() || !canWrite() || opp.stage === 'LOST'"
                >
                  Marcar perdida
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
      <p *ngIf="opportunities().length === 0">Nenhuma oportunidade encontrada.</p>
    </article>
  </div>
</section>
