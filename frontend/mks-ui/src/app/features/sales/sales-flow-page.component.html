<section class="sales-wrap">
  <h1>Fluxo Comercial</h1>

  <div *ngIf="session()" class="meta">
    <span><strong>Tenant:</strong> {{ session()?.tenantCode }}</span>
    <span><strong>Usuário:</strong> {{ session()?.username }}</span>
    <span><strong>Role:</strong> {{ session()?.role }}</span>
  </div>

  <div class="toolbar">
    <button pButton type="button" (click)="load()" [disabled]="loading()">Atualizar painel</button>
  </div>

  <p *ngIf="loading()">Carregando...</p>
  <p *ngIf="error()" class="error">{{ error() }}</p>
  <p *ngIf="notice()" class="notice">{{ notice() }}</p>

  <p-card styleClass="card metrics-card" *ngIf="metrics() as m">
    <h2>Visão Comercial Prioritária</h2>
    <p class="filters-summary">
      Período: {{ m.period.from_date || "início" }} até {{ m.period.to_date || "hoje" }}
    </p>
    <div class="metrics-grid">
      <div class="metric-item">
        <span class="metric-label">Leads Novos</span>
        <strong class="metric-value">{{ m.lead_funnel.NEW }}</strong>
      </div>
      <div class="metric-item">
        <span class="metric-label">Leads Qualificados</span>
        <strong class="metric-value">{{ m.lead_funnel.QUALIFIED }}</strong>
      </div>
      <div class="metric-item">
        <span class="metric-label">Leads Convertidos</span>
        <strong class="metric-value">{{ m.lead_funnel.CONVERTED }}</strong>
      </div>
      <div class="metric-item">
        <span class="metric-label">Oportunidades Ganhas</span>
        <strong class="metric-value">{{ m.opportunity_funnel.WON }}</strong>
      </div>
      <div class="metric-item">
        <span class="metric-label">Taxa de Fechamento</span>
        <strong class="metric-value">{{ m.conversion.opportunity_win_rate | number: "1.0-2" }}%</strong>
      </div>
      <div class="metric-item">
        <span class="metric-label">Pipeline Aberto</span>
        <strong class="metric-value">{{ formatCurrency(m.pipeline_value.open_total_amount) }}</strong>
      </div>
      <div class="metric-item">
        <span class="metric-label">Previsto 30 dias</span>
        <strong class="metric-value">{{ formatCurrency(m.pipeline_value.expected_close_next_30d_amount) }}</strong>
      </div>
      <div class="metric-item">
        <span class="metric-label">Atividades Atrasadas</span>
        <strong class="metric-value">{{ m.activities.overdue_total }}</strong>
      </div>
    </div>
  </p-card>

  <div class="grid">
    <p-card styleClass="card">
      <h2>Entrada Comercial (Lead/Prospect)</h2>
      <p class="hint">
        Cadastro único de entrada. O cliente é criado automaticamente na conversão do lead.
      </p>
      <div class="form-grid">
        <label>
          Origem *
          <input pInputText
            type="text"
            [ngModel]="leadSource()"
            (ngModelChange)="leadSource.set($event)"
            [disabled]="loading() || !canWrite()"
            placeholder="Site, indicação, campanha..."
          />
        </label>
        <label>
          Nome do contato
          <input pInputText
            type="text"
            [ngModel]="leadFullName()"
            (ngModelChange)="leadFullName.set($event)"
            [disabled]="loading() || !canWrite()"
          />
        </label>
        <label>
          Empresa
          <input pInputText
            type="text"
            [ngModel]="leadCompanyName()"
            (ngModelChange)="leadCompanyName.set($event)"
            [disabled]="loading() || !canWrite()"
          />
        </label>
        <label>
          E-mail
          <input pInputText
            type="email"
            [ngModel]="leadEmail()"
            (ngModelChange)="leadEmail.set($event)"
            [disabled]="loading() || !canWrite()"
          />
        </label>
        <label>
          Telefone
          <input pInputText
            type="text"
            [ngModel]="leadPhone()"
            (ngModelChange)="leadPhone.set($event)"
            [disabled]="loading() || !canWrite()"
          />
        </label>
        <label>
          CNPJ
          <input pInputText
            type="text"
            [ngModel]="leadCnpj()"
            (ngModelChange)="leadCnpj.set($event)"
            [disabled]="loading() || !canWrite()"
            placeholder="00.000.000/0001-00"
          />
        </label>
        <label>
          Produtos de interesse
          <input pInputText
            type="text"
            [ngModel]="leadProductsOfInterest()"
            (ngModelChange)="leadProductsOfInterest.set($event)"
            [disabled]="loading() || !canWrite()"
            placeholder="Auto, Vida, Empresarial..."
          />
        </label>
        <label>
          Orçamento estimado
          <input pInputText
            type="number"
            [ngModel]="leadEstimatedBudget()"
            (ngModelChange)="leadEstimatedBudget.set($event)"
            [disabled]="loading() || !canWrite()"
          />
        </label>
        <label class="field-full">
          Observações
          <textarea pInputTextarea
            rows="2"
            [ngModel]="leadNotes()"
            (ngModelChange)="leadNotes.set($event)"
            [disabled]="loading() || !canWrite()"
          ></textarea>
        </label>
      </div>
      <div class="actions top-gap">
        <button pButton type="button" (click)="createLead()" [disabled]="loading() || !canWrite()">
          Criar lead
        </button>
      </div>
    </p-card>

    <p-card styleClass="card">
      <h2>Atividade / Follow-up</h2>
      <div class="form-grid">
        <label>
          Tipo
          <p-select
            [options]="activityKindOptions"
            optionLabel="label"
            optionValue="value"
            [ngModel]="activityKind()"
            (ngModelChange)="activityKind.set($event)"
            [disabled]="loading() || !canWrite()"
          ></p-select>
        </label>
        <label>
          Prioridade
          <p-select
            [options]="activityPriorityOptions"
            optionLabel="label"
            optionValue="value"
            [ngModel]="activityPriority()"
            (ngModelChange)="activityPriority.set($event)"
            [disabled]="loading() || !canWrite()"
          ></p-select>
        </label>
        <label class="field-full">
          Título *
          <input pInputText
            type="text"
            [ngModel]="activityTitle()"
            (ngModelChange)="activityTitle.set($event)"
            [disabled]="loading() || !canWrite()"
            placeholder="Ex.: Follow-up proposta renovação"
          />
        </label>
        <label>
          Vínculo
          <p-select
            [options]="activityTargetTypeOptions"
            optionLabel="label"
            optionValue="value"
            [ngModel]="activityTargetType()"
            (ngModelChange)="onActivityTargetTypeChange($event)"
            [disabled]="loading() || !canWrite()"
          ></p-select>
        </label>
        <label>
          Registro
          <p-select
            *ngIf="activityTargetType() === 'LEAD'"
            [options]="leadTargetOptions()"
            [ngModel]="activityTargetId()"
            (ngModelChange)="activityTargetId.set($event)"
            [disabled]="loading() || !canWrite()"
            placeholder="Selecione..."
          ></p-select>
          <p-select
            *ngIf="activityTargetType() === 'OPPORTUNITY'"
            [options]="opportunityTargetOptions()"
            [ngModel]="activityTargetId()"
            (ngModelChange)="activityTargetId.set($event)"
            [disabled]="loading() || !canWrite()"
            placeholder="Selecione..."
          ></p-select>
        </label>
        <label>
          Vencimento
          <input pInputText
            type="datetime-local"
            [ngModel]="activityDueAt()"
            (ngModelChange)="activityDueAt.set($event)"
            [disabled]="loading() || !canWrite()"
          />
        </label>
        <label>
          Lembrete
          <input pInputText
            type="datetime-local"
            [ngModel]="activityReminderAt()"
            (ngModelChange)="activityReminderAt.set($event)"
            [disabled]="loading() || !canWrite()"
          />
        </label>
        <label>
          SLA (horas)
          <input pInputText
            type="number"
            min="1"
            [ngModel]="activitySlaHours()"
            (ngModelChange)="activitySlaHours.set($event)"
            [disabled]="loading() || !canWrite()"
            placeholder="24"
          />
        </label>
      </div>
      <div class="actions top-gap">
        <button pButton type="button" (click)="createActivity()" [disabled]="loading() || !canWrite()">
          Criar atividade
        </button>
      </div>
    </p-card>
  </div>

  <div class="grid secondary-grid">
    <p-card styleClass="card">
      <h2>Leads</h2>
      <p-table *ngIf="leads().length > 0" class="table" [value]="leads()" responsiveLayout="scroll">
        <ng-template pTemplate="header">
          <tr>
            <th>ID</th>
            <th>Origem</th>
            <th>Empresa</th>
            <th>Status</th>
            <th>CNPJ</th>
            <th>Ações</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-lead>
          <tr>
            <td>{{ lead.id }}</td>
            <td>{{ lead.source }}</td>
            <td>{{ lead.company_name || "-" }}</td>
            <td>{{ lead.status }}</td>
            <td>{{ lead.cnpj || "-" }}</td>
            <td>
              <div class="actions">
                <button pButton type="button" (click)="qualifyLead(lead)" [disabled]="loading() || !canWrite() || lead.status !== 'NEW'">Qualificar</button>
                <button pButton type="button" (click)="convertLead(lead)" [disabled]="loading() || !canWrite() || lead.status !== 'QUALIFIED'">Converter</button>
                <button pButton type="button" (click)="generateLeadInsights(lead)" [disabled]="loading() || !canWrite()">Insights IA</button>
                <button pButton type="button" (click)="enrichLeadCnpj(lead)" [disabled]="loading() || !canWrite()">Enriquecer CNPJ</button>
              </div>
            </td>
          </tr>
        </ng-template>
      </p-table>
      <p *ngIf="leads().length === 0">Nenhum lead encontrado.</p>
    </p-card>

    <p-card styleClass="card">
      <h2>Oportunidades</h2>
      <p-table *ngIf="opportunities().length > 0" class="table" [value]="opportunities()" responsiveLayout="scroll">
        <ng-template pTemplate="header">
          <tr>
            <th>ID</th>
            <th>Título</th>
            <th>Estágio</th>
            <th>Valor</th>
            <th>Probabilidade</th>
            <th>Ações</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-opp>
          <tr>
            <td>{{ opp.id }}</td>
            <td>{{ opp.title }}</td>
            <td>{{ opp.stage }}</td>
            <td>{{ opp.amount }}</td>
            <td>{{ opp.closing_probability }}%</td>
            <td>
              <div class="actions">
                <button pButton type="button" (click)="moveToNextStage(opp)" [disabled]="loading() || !canWrite()">Próximo estágio</button>
                <button pButton type="button" (click)="markLost(opp)" [disabled]="loading() || !canWrite() || opp.stage === 'LOST'">Perdida</button>
                <button pButton type="button" (click)="generateOpportunityInsights(opp)" [disabled]="loading() || !canWrite()">Insights IA</button>
              </div>
            </td>
          </tr>
        </ng-template>
      </p-table>
      <p *ngIf="opportunities().length === 0">Nenhuma oportunidade encontrada.</p>
    </p-card>
  </div>

  <div class="grid secondary-grid">
    <p-card styleClass="card">
      <h2>Atividades</h2>
      <p-table *ngIf="activities().length > 0" class="table" [value]="activities()" responsiveLayout="scroll">
        <ng-template pTemplate="header">
          <tr>
            <th>ID</th>
            <th>Título</th>
            <th>Status</th>
            <th>Prioridade</th>
            <th>Vínculo</th>
            <th>SLA</th>
            <th>Ações</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-activity>
          <tr>
            <td>{{ activity.id }}</td>
            <td>{{ activity.title }}</td>
            <td>{{ activity.status }}</td>
            <td>{{ activity.priority }}</td>
            <td>
              <span *ngIf="activity.lead">Lead #{{ activity.lead }}</span>
              <span *ngIf="activity.opportunity">Opp #{{ activity.opportunity }}</span>
            </td>
            <td><span [class.badge-alert]="activity.is_sla_breached">{{ activity.sla_due_at || "-" }}</span></td>
            <td>
              <div class="actions">
                <button pButton type="button" (click)="completeActivity(activity)" [disabled]="loading() || !canWrite() || activity.status === 'DONE'">Concluir</button>
                <button pButton type="button" (click)="reopenActivity(activity)" [disabled]="loading() || !canWrite() || activity.status !== 'DONE'">Reabrir</button>
              </div>
            </td>
          </tr>
        </ng-template>
      </p-table>
      <p *ngIf="activities().length === 0">Nenhuma atividade cadastrada.</p>
    </p-card>

    <p-card styleClass="card">
      <h2>Lembretes Pendentes</h2>
      <p-table *ngIf="reminderActivities().length > 0" class="table" [value]="reminderActivities()" responsiveLayout="scroll">
        <ng-template pTemplate="header">
          <tr>
            <th>ID</th>
            <th>Título</th>
            <th>Lembrete</th>
            <th>Ação</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-activity>
          <tr>
            <td>{{ activity.id }}</td>
            <td>{{ activity.title }}</td>
            <td>{{ activity.reminder_at }}</td>
            <td>
              <button pButton type="button" (click)="markReminderSent(activity)" [disabled]="loading() || !canWrite() || activity.reminder_sent">
                Marcar enviado
              </button>
            </td>
          </tr>
        </ng-template>
      </p-table>
      <p *ngIf="reminderActivities().length === 0">Não há lembretes pendentes.</p>
    </p-card>
  </div>
</section>
