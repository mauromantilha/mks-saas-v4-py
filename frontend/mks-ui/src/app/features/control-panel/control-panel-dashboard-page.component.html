<section class="dashboard-wrap">
  <header class="page-header">
    <div>
      <h1>Dashboard</h1>
      <p>Visão geral operacional do Control Panel com foco em risco dos tenants.</p>
    </div>

    <div class="header-actions">
      <mat-form-field appearance="outline">
        <mat-label>Período</mat-label>
        <mat-select [ngModel]="selectedPeriod()" (ngModelChange)="onPeriodChange($event)">
          <mat-option *ngFor="let option of periodOptions" [value]="option.value">
            {{ option.label }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <button mat-stroked-button type="button" (click)="reload()" [disabled]="loading()">
        <mat-icon>refresh</mat-icon>
        Atualizar
      </button>
    </div>
  </header>

  <mat-card class="thresholds-card">
    <h3>Critérios de risco</h3>
    <div class="thresholds-grid">
      <mat-form-field appearance="outline">
        <mat-label>Heartbeat (minutos)</mat-label>
        <input
          matInput
          type="number"
          min="1"
          max="1440"
          [ngModel]="heartbeatThresholdMinutes()"
          (ngModelChange)="onThresholdMinutesChange($event)"
        />
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Error rate (%)</mat-label>
        <input
          matInput
          type="number"
          min="0.1"
          max="100"
          step="0.1"
          [ngModel]="errorThresholdPercent()"
          (ngModelChange)="onErrorThresholdChange($event)"
        />
      </mat-form-field>
    </div>
  </mat-card>

  <app-loading-state *ngIf="loading()" message="Carregando dashboard..."></app-loading-state>

  <app-error-state
    *ngIf="!loading() && error()"
    [message]="error()"
    retryLabel="Tentar novamente"
    (retry)="reload()"
  ></app-error-state>

  <ng-container *ngIf="!loading() && !error() && monitoring() as data">
    <div class="summary-grid">
      <mat-card>
        <span class="label">Serviços monitorados</span>
        <strong>{{ data.summary.total_services }}</strong>
      </mat-card>
      <mat-card>
        <span class="label">Tenants monitorados</span>
        <strong>{{ data.summary.total_tenants }}</strong>
      </mat-card>
      <mat-card>
        <span class="label">Tenants em risco</span>
        <strong>{{ riskyCount() }}</strong>
      </mat-card>
      <mat-card>
        <span class="label">Alertas abertos</span>
        <strong>{{ data.summary.open_alerts ?? 0 }}</strong>
      </mat-card>
    </div>

    <app-control-panel-alerts-widget
      [monitoring]="data"
      [heartbeatThresholdMinutes]="heartbeatThresholdMinutes()"
      [errorRateThresholdPercent]="errorThresholdPercent()"
      (openTenant)="onOpenTenant($event)"
      (refreshRequested)="reload()"
    ></app-control-panel-alerts-widget>
  </ng-container>
</section>

