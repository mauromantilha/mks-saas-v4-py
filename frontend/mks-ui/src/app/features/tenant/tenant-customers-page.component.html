<section class="tenant-wrap">
  <header class="page-header">
    <div>
      <p class="badge">CRM</p>
      <h1>Clientes</h1>
      <p class="subtitle">
        Cadastro completo, histórico comercial e inteligência aplicada ao perfil do cliente.
      </p>
    </div>
    <button type="button" (click)="load()" [disabled]="loading()">Atualizar</button>
  </header>

  <p *ngIf="loading()" class="muted">Carregando...</p>
  <p *ngIf="error()" class="error">{{ error() }}</p>
  <p *ngIf="notice()" class="notice">{{ notice() }}</p>

  <article class="card">
    <h2>Novo Cliente</h2>
    <p class="muted">
      O modelo suporta dezenas de campos. Aqui é um cadastro inicial para acelerar o pipeline.
    </p>

    <div class="form-grid">
      <label>
        Nome (obrigatório)
        <input
          type="text"
          [ngModel]="name()"
          (ngModelChange)="name.set($event)"
          [disabled]="loading() || !canWrite()"
        />
      </label>
      <label>
        E-mail (obrigatório)
        <input
          type="email"
          [ngModel]="email()"
          (ngModelChange)="email.set($event)"
          [disabled]="loading() || !canWrite()"
        />
      </label>
      <label>
        CNPJ
        <input
          type="text"
          [ngModel]="cnpj()"
          (ngModelChange)="cnpj.set($event)"
          [disabled]="loading() || !canWrite()"
        />
      </label>
      <label>
        Telefone
        <input
          type="text"
          [ngModel]="phone()"
          (ngModelChange)="phone.set($event)"
          [disabled]="loading() || !canWrite()"
        />
      </label>
      <label>
        Contato principal
        <input
          type="text"
          [ngModel]="contactName()"
          (ngModelChange)="contactName.set($event)"
          [disabled]="loading() || !canWrite()"
        />
      </label>
      <label>
        Segmento
        <input
          type="text"
          [ngModel]="industry()"
          (ngModelChange)="industry.set($event)"
          [disabled]="loading() || !canWrite()"
        />
      </label>
      <label>
        Origem
        <input
          type="text"
          [ngModel]="leadSource()"
          (ngModelChange)="leadSource.set($event)"
          [disabled]="loading() || !canWrite()"
        />
      </label>
      <label class="field-full">
        Observações
        <textarea
          rows="2"
          [ngModel]="notes()"
          (ngModelChange)="notes.set($event)"
          [disabled]="loading() || !canWrite()"
        ></textarea>
      </label>
    </div>

    <div class="actions top-gap">
      <button type="button" (click)="createCustomer()" [disabled]="loading() || !canWrite()">
        Criar cliente
      </button>
    </div>
  </article>

  <article class="card">
    <h2>Lista de Clientes</h2>
    <table class="table" *ngIf="customers().length > 0">
      <thead>
        <tr>
          <th>ID</th>
          <th>Nome</th>
          <th>E-mail</th>
          <th>CNPJ</th>
          <th>Etapa</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let c of customers()">
          <td>{{ c.id }}</td>
          <td>{{ c.name }}</td>
          <td>{{ c.email }}</td>
          <td>{{ c.cnpj || "-" }}</td>
          <td>{{ c.lifecycle_stage }}</td>
          <td>
            <div class="actions compact">
              <button type="button" (click)="generateInsights(c)" [disabled]="loading()">
                IA
              </button>
              <button
                type="button"
                (click)="enrichCnpj(c)"
                [disabled]="loading() || !canWrite()"
              >
                Enriquecer
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
    <p *ngIf="customers().length === 0" class="muted">Nenhum cliente encontrado.</p>
  </article>

  <article class="card ai-card" *ngIf="aiResponse() as ai">
    <header class="ai-header">
      <h2>Insights IA</h2>
      <span class="muted">{{ aiEntityLabel() }} | Provider: {{ ai.insights.provider }}</span>
    </header>
    <p><strong>Resumo:</strong> {{ ai.insights.summary }}</p>
    <div class="ai-grid">
      <div>
        <h3>Riscos</h3>
        <ul>
          <li *ngFor="let item of ai.insights.risks">{{ item }}</li>
        </ul>
      </div>
      <div>
        <h3>Oportunidades</h3>
        <ul>
          <li *ngFor="let item of ai.insights.opportunities">{{ item }}</li>
        </ul>
      </div>
      <div>
        <h3>Próximas ações</h3>
        <ul>
          <li *ngFor="let item of ai.insights.next_actions">{{ item }}</li>
        </ul>
      </div>
    </div>
  </article>
</section>

