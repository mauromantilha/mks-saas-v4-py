<section class="tenant-wrap">
  <header class="page-header">
    <div>
      <p class="badge">CRM</p>
      <h1>Clientes</h1>
      <p class="subtitle">
        Cadastro completo, histórico comercial e inteligência aplicada ao perfil do cliente.
      </p>
    </div>
    <button type="button" (click)="load()" [disabled]="loading()">Atualizar</button>
  </header>

  <p *ngIf="loading()" class="muted">Carregando...</p>
  <p *ngIf="error()" class="error">{{ error() }}</p>
  <p *ngIf="notice()" class="notice">{{ notice() }}</p>

  <article class="card">
    <h2>Novo Cliente</h2>
    <p class="muted">
      Cadastre cliente com endereço completo. Ao informar o CEP, o sistema busca e completa o
      endereço automaticamente. Para Pessoa Jurídica, adicione múltiplos contatos.
    </p>

    <div class="form-grid">
      <label>
        Tipo de cliente
        <select
          [ngModel]="customerType()"
          (ngModelChange)="setCustomerType($event)"
          [disabled]="loading() || !canWrite()"
        >
          <option value="INDIVIDUAL">Pessoa Física</option>
          <option value="COMPANY">Pessoa Jurídica</option>
        </select>
      </label>
      <label>
        Nome (obrigatório)
        <input
          type="text"
          [ngModel]="name()"
          (ngModelChange)="name.set($event)"
          [disabled]="loading() || !canWrite()"
        />
      </label>
      <label>
        E-mail (obrigatório)
        <input
          type="email"
          [ngModel]="email()"
          (ngModelChange)="email.set($event)"
          [disabled]="loading() || !canWrite()"
        />
      </label>
      <label *ngIf="customerType() === 'INDIVIDUAL'">
        CPF (obrigatório)
        <input
          type="text"
          [ngModel]="cpf()"
          (ngModelChange)="cpf.set($event)"
          [disabled]="loading() || !canWrite()"
        />
      </label>
      <label *ngIf="customerType() === 'COMPANY'">
        CNPJ (obrigatório)
        <input
          type="text"
          [ngModel]="cnpj()"
          (ngModelChange)="cnpj.set($event)"
          [disabled]="loading() || !canWrite()"
        />
      </label>
      <label>
        Telefone
        <input
          type="text"
          [ngModel]="phone()"
          (ngModelChange)="phone.set($event)"
          [disabled]="loading() || !canWrite()"
        />
      </label>
      <label>
        WhatsApp
        <input
          type="text"
          [ngModel]="whatsapp()"
          (ngModelChange)="whatsapp.set($event)"
          [disabled]="loading() || !canWrite()"
        />
      </label>
      <label>
        CEP (obrigatório)
        <div class="inline-field">
          <input
            type="text"
            [ngModel]="zipCode()"
            (ngModelChange)="zipCode.set($event)"
            (blur)="lookupCep()"
            [disabled]="loading() || cepLoading() || !canWrite()"
          />
          <button
            type="button"
            class="secondary"
            (click)="lookupCep()"
            [disabled]="loading() || cepLoading() || !canWrite()"
          >
            Buscar
          </button>
        </div>
        <small *ngIf="cepLoading()" class="muted">Consultando CEP...</small>
        <small *ngIf="cepError()" class="error">{{ cepError() }}</small>
      </label>
      <label>
        Endereço (logradouro) (obrigatório)
        <input
          type="text"
          [ngModel]="street()"
          (ngModelChange)="street.set($event)"
          [disabled]="loading() || !canWrite()"
        />
      </label>
      <label>
        Número (obrigatório)
        <input
          type="text"
          [ngModel]="streetNumber()"
          (ngModelChange)="streetNumber.set($event)"
          [disabled]="loading() || !canWrite()"
        />
      </label>
      <label>
        Complemento
        <input
          type="text"
          [ngModel]="addressComplement()"
          (ngModelChange)="addressComplement.set($event)"
          [disabled]="loading() || !canWrite()"
        />
      </label>
      <label>
        Bairro (obrigatório)
        <input
          type="text"
          [ngModel]="neighborhood()"
          (ngModelChange)="neighborhood.set($event)"
          [disabled]="loading() || !canWrite()"
        />
      </label>
      <label>
        Cidade (obrigatório)
        <input
          type="text"
          [ngModel]="city()"
          (ngModelChange)="city.set($event)"
          [disabled]="loading() || !canWrite()"
        />
      </label>
      <label>
        Estado/UF (obrigatório)
        <input
          type="text"
          [ngModel]="state()"
          (ngModelChange)="state.set($event)"
          [disabled]="loading() || !canWrite()"
        />
      </label>
      <label>
        Segmento
        <input
          type="text"
          [ngModel]="industry()"
          (ngModelChange)="industry.set($event)"
          [disabled]="loading() || !canWrite()"
        />
      </label>
      <label>
        Origem
        <input
          type="text"
          [ngModel]="leadSource()"
          (ngModelChange)="leadSource.set($event)"
          [disabled]="loading() || !canWrite()"
        />
      </label>
      <div class="field-full" *ngIf="isCompany()">
        <h3>Contatos (Pessoa Jurídica)</h3>
        <p class="muted">
          Adicione um ou mais contatos. Marque um contato como primário (o primeiro será usado se
          nenhum estiver marcado).
        </p>

        <div class="contacts">
          <div class="contact-card" *ngFor="let c of contacts(); let i = index">
            <div class="contact-header">
              <div class="contact-title">
                <strong>Contato {{ i + 1 }}</strong>
                <span class="muted" *ngIf="c.is_primary">Primário</span>
              </div>
              <div class="actions compact">
                <label class="radio">
                  <input
                    type="radio"
                    name="primary_contact"
                    [checked]="c.is_primary"
                    (change)="markPrimary(i)"
                    [disabled]="loading() || !canWrite()"
                  />
                  Primário
                </label>
                <button
                  type="button"
                  class="danger ghost"
                  (click)="removeContact(i)"
                  [disabled]="loading() || !canWrite()"
                >
                  Remover
                </button>
              </div>
            </div>

            <div class="form-grid contact-grid">
              <label>
                Nome (obrigatório)
                <input
                  type="text"
                  [ngModel]="c.name"
                  (ngModelChange)="updateContact(i, 'name', $event)"
                  [disabled]="loading() || !canWrite()"
                />
              </label>
              <label>
                Email
                <input
                  type="email"
                  [ngModel]="c.email"
                  (ngModelChange)="updateContact(i, 'email', $event)"
                  [disabled]="loading() || !canWrite()"
                />
              </label>
              <label>
                Telefone
                <input
                  type="text"
                  [ngModel]="c.phone"
                  (ngModelChange)="updateContact(i, 'phone', $event)"
                  [disabled]="loading() || !canWrite()"
                />
              </label>
              <label>
                Cargo
                <input
                  type="text"
                  [ngModel]="c.role"
                  (ngModelChange)="updateContact(i, 'role', $event)"
                  [disabled]="loading() || !canWrite()"
                />
              </label>
              <label class="field-full">
                Notas
                <textarea
                  rows="2"
                  [ngModel]="c.notes"
                  (ngModelChange)="updateContact(i, 'notes', $event)"
                  [disabled]="loading() || !canWrite()"
                ></textarea>
              </label>
            </div>
          </div>
        </div>

        <div class="actions top-gap">
          <button type="button" (click)="addContact()" [disabled]="loading() || !canWrite()">
            Adicionar contato
          </button>
        </div>
      </div>
      <label class="field-full">
        Observações
        <textarea
          rows="2"
          [ngModel]="notes()"
          (ngModelChange)="notes.set($event)"
          [disabled]="loading() || !canWrite()"
        ></textarea>
      </label>
    </div>

    <div class="actions top-gap">
      <button type="button" (click)="createCustomer()" [disabled]="loading() || !canWrite()">
        Criar cliente
      </button>
    </div>
  </article>

  <article class="card">
    <h2>Lista de Clientes</h2>
    <table class="table" *ngIf="customers().length > 0">
      <thead>
        <tr>
          <th>ID</th>
          <th>Nome</th>
          <th>E-mail</th>
          <th>CNPJ</th>
          <th>Etapa</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let c of customers()">
          <td>{{ c.id }}</td>
          <td>{{ c.name }}</td>
          <td>{{ c.email }}</td>
          <td>{{ c.cnpj || "-" }}</td>
          <td>{{ c.lifecycle_stage }}</td>
          <td>
            <div class="actions compact">
              <button type="button" (click)="generateInsights(c)" [disabled]="loading()">
                IA
              </button>
              <button
                type="button"
                (click)="enrichCnpj(c)"
                [disabled]="loading() || !canWrite()"
              >
                Enriquecer
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
    <p *ngIf="customers().length === 0" class="muted">Nenhum cliente encontrado.</p>
  </article>

  <article class="card ai-card" *ngIf="aiResponse() as ai">
    <header class="ai-header">
      <h2>Insights IA</h2>
      <span class="muted">{{ aiEntityLabel() }} | Provider: {{ ai.insights.provider }}</span>
    </header>
    <p><strong>Resumo:</strong> {{ ai.insights.summary }}</p>
    <div class="ai-grid">
      <div>
        <h3>Riscos</h3>
        <ul>
          <li *ngFor="let item of ai.insights.risks">{{ item }}</li>
        </ul>
      </div>
      <div>
        <h3>Oportunidades</h3>
        <ul>
          <li *ngFor="let item of ai.insights.opportunities">{{ item }}</li>
        </ul>
      </div>
      <div>
        <h3>Próximas ações</h3>
        <ul>
          <li *ngFor="let item of ai.insights.next_actions">{{ item }}</li>
        </ul>
      </div>
    </div>
  </article>
</section>
