<section class="tenant-wrap sakai-page">
  <header class="page-header surface-card">
    <div class="title-wrap">
      <p class="badge">CRM</p>
      <h1>Clientes</h1>
      <p class="subtitle">
        Cadastro completo, ficha detalhada e gestão de status do cliente por tenant.
      </p>
    </div>
    <i class="pi pi-users header-icon" aria-hidden="true"></i>
    <button pButton type="button" (click)="load()" [disabled]="loading()">Atualizar</button>
  </header>

  <p *ngIf="loading()" class="muted">Carregando...</p>
  <p *ngIf="error()" class="error">{{ error() }}</p>
  <p *ngIf="notice()" class="notice">{{ notice() }}</p>

  <p-card styleClass="card">
    <h2>Novo Cliente</h2>
    <p class="muted">Campos com <strong>*</strong> são obrigatórios.</p>

    <div class="form-grid">
      <label>
        Ação
        <p-select
          [options]="actionOptions"
          optionLabel="label"
          optionValue="value"
          [ngModel]="createAction()"
          (ngModelChange)="createAction.set($event)"
          [disabled]="loading() || !canWrite()"
          placeholder="Selecione a ação"
        ></p-select>
      </label>
      <label>
        Tipo de cliente *
        <select
          [(ngModel)]="createForm.customer_type"
          (ngModelChange)="setCreateType($event)"
          [disabled]="loading() || !canWrite()"
        >
          <option value="INDIVIDUAL">Pessoa Física</option>
          <option value="COMPANY">Pessoa Jurídica</option>
        </select>
      </label>

      <label>
        Nome *
        <input pInputText type="text" [(ngModel)]="createForm.name" [disabled]="loading() || !canWrite()" />
      </label>

      <label>
        E-mail *
        <input pInputText
          type="email"
          [(ngModel)]="createForm.email"
          [disabled]="loading() || !canWrite()"
        />
      </label>

      <label *ngIf="createForm.customer_type === 'INDIVIDUAL'">
        CPF *
        <input pInputText type="text" [(ngModel)]="createForm.cpf" [disabled]="loading() || !canWrite()" />
      </label>

      <label *ngIf="createForm.customer_type === 'COMPANY'">
        CNPJ *
        <input pInputText
          type="text"
          [(ngModel)]="createForm.cnpj"
          [disabled]="loading() || !canWrite()"
        />
      </label>

      <label>
        Telefone
        <input pInputText type="text" [(ngModel)]="createForm.phone" [disabled]="loading() || !canWrite()" />
      </label>

      <label>
        WhatsApp
        <input pInputText
          type="text"
          [(ngModel)]="createForm.whatsapp"
          [disabled]="loading() || !canWrite()"
        />
      </label>

      <label class="cep-field">
        CEP *
        <div class="inline-field">
          <input pInputText
            type="text"
            [(ngModel)]="createForm.zip_code"
            (blur)="lookupCreateCep()"
            [disabled]="loading() || createCepLoading() || !canWrite()"
          />
          <button pButton
            type="button"
            class="secondary"
            (click)="lookupCreateCep()"
            [disabled]="loading() || createCepLoading() || !canWrite()"
          >
            Buscar
          </button>
        </div>
        <small *ngIf="createCepLoading()" class="muted">Consultando CEP...</small>
        <small *ngIf="createCepError()" class="error">{{ createCepError() }}</small>
      </label>

      <label>
        Endereço *
        <input pInputText
          type="text"
          [(ngModel)]="createForm.street"
          [disabled]="loading() || !canWrite()"
        />
      </label>

      <label>
        Número *
        <input pInputText
          type="text"
          [(ngModel)]="createForm.street_number"
          [disabled]="loading() || !canWrite()"
        />
      </label>

      <label>
        Complemento
        <input pInputText
          type="text"
          [(ngModel)]="createForm.address_complement"
          [disabled]="loading() || !canWrite()"
        />
      </label>

      <label>
        Bairro *
        <input pInputText
          type="text"
          [(ngModel)]="createForm.neighborhood"
          [disabled]="loading() || !canWrite()"
        />
      </label>

      <label>
        Cidade *
        <input pInputText type="text" [(ngModel)]="createForm.city" [disabled]="loading() || !canWrite()" />
      </label>

      <label>
        Estado/UF *
        <input pInputText type="text" [(ngModel)]="createForm.state" [disabled]="loading() || !canWrite()" />
      </label>

      <label>
        Segmento *
        <select [(ngModel)]="createForm.industry" [disabled]="loading() || !canWrite()">
          <option value="">Selecione...</option>
          <option *ngFor="let opt of industryOptions" [value]="opt.value">{{ opt.label }}</option>
        </select>
      </label>

      <label>
        Origem *
        <select [(ngModel)]="createForm.lead_source" [disabled]="loading() || !canWrite()">
          <option value="">Selecione...</option>
          <option *ngFor="let opt of leadSourceOptions" [value]="opt.value">{{ opt.label }}</option>
        </select>
      </label>

      <div class="field-full" *ngIf="createForm.customer_type === 'COMPANY'">
        <h3>Contatos</h3>
        <p class="muted">Pessoa jurídica exige pelo menos um contato com nome e email/telefone.</p>

        <div class="contacts">
          <div class="contact-card" *ngFor="let c of createForm.contacts; let i = index">
            <div class="contact-header">
              <div class="contact-title">
                <strong>Contato {{ i + 1 }}</strong>
                <span class="muted" *ngIf="c.is_primary">Primário</span>
              </div>
              <div class="actions compact">
                <label class="radio">
                  <input
                    type="radio"
                    name="primary_contact_create"
                    [checked]="c.is_primary"
                    (change)="markCreatePrimary(i)"
                    [disabled]="loading() || !canWrite()"
                  />
                  Primário
                </label>
                <button pButton
                  type="button"
                  class="danger ghost"
                  (click)="removeCreateContact(i)"
                  [disabled]="loading() || !canWrite()"
                >
                  Remover
                </button>
              </div>
            </div>

            <div class="form-grid contact-grid">
              <label>
                Nome *
                <input pInputText type="text" [(ngModel)]="c.name" [disabled]="loading() || !canWrite()" />
              </label>
              <label>
                E-mail
                <input pInputText
                  type="email"
                  [(ngModel)]="c.email"
                  [disabled]="loading() || !canWrite()"
                />
              </label>
              <label>
                Telefone
                <input pInputText type="text" [(ngModel)]="c.phone" [disabled]="loading() || !canWrite()" />
              </label>
              <label>
                Cargo
                <input pInputText type="text" [(ngModel)]="c.role" [disabled]="loading() || !canWrite()" />
              </label>
              <label class="field-full">
                Notas
                <textarea pInputTextarea rows="2" [(ngModel)]="c.notes" [disabled]="loading() || !canWrite()"></textarea>
              </label>
            </div>
          </div>
        </div>

        <div class="actions top-gap">
          <button pButton type="button" (click)="addCreateContact()" [disabled]="loading() || !canWrite()">
            Adicionar contato
          </button>
        </div>
      </div>

      <label class="field-full">
        Observações
        <textarea pInputTextarea rows="2" [(ngModel)]="createForm.notes" [disabled]="loading() || !canWrite()"></textarea>
      </label>
    </div>

    <div class="actions top-gap">
      <button pButton
        type="button"
        (click)="createCustomer()"
        [disabled]="loading() || !canWrite() || !isCreateValid()"
      >
        Criar cliente
      </button>
    </div>
  </p-card>

  <p-card styleClass="card">
    <h2>Lista de Clientes</h2>
    <p-table class="table" *ngIf="customers().length > 0; else noCustomers" [value]="customers()" responsiveLayout="scroll">
      <ng-template pTemplate="header">
        <tr>
          <th>ID</th>
          <th>Nome</th>
          <th>E-mail</th>
          <th>Documento</th>
          <th>Segmento</th>
          <th>Status</th>
          <th>Ações</th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-c>
        <tr>
          <td>#{{ c.id }}</td>
          <td>{{ c.name }}</td>
          <td>{{ c.email }}</td>
          <td>{{ c.cnpj || c.cpf || c.document || '-' }}</td>
          <td>{{ getIndustryLabel(c.industry) }}</td>
          <td>
            <span class="pill" [class.inactive]="c.lifecycle_stage === 'INACTIVE'">
              {{ c.lifecycle_stage }}
            </span>
          </td>
          <td>
            <div class="actions compact">
              <button pButton type="button" class="secondary" (click)="openCustomer(c.id)">Ficha</button>
              <button pButton type="button" (click)="generateInsights(c)" [disabled]="loading()">IA</button>
              <button pButton type="button" (click)="enrichCnpj(c)" [disabled]="loading() || !canWrite()">
                Enriquecer
              </button>
              <button pButton
                type="button"
                class="warning"
                (click)="inactivateCustomer(c)"
                [disabled]="loading() || !canWrite() || c.lifecycle_stage === 'INACTIVE'"
              >
                Inativar
              </button>
              <button pButton type="button" class="danger" (click)="deleteCustomer(c)" [disabled]="loading() || !canWrite()">
                Excluir
              </button>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
    <ng-template #noCustomers>
      <p class="muted">Nenhum cliente encontrado.</p>
    </ng-template>
  </p-card>

  <p-card styleClass="card" *ngIf="selectedCustomer() as selected">
    <header class="detail-header">
      <div>
        <h2>Ficha do Cliente #{{ selected.id }}</h2>
        <p class="muted">{{ selected.name }} | {{ selected.customer_type }} | {{ selected.lifecycle_stage }}</p>
      </div>
      <div class="actions">
        <button pButton type="button" class="secondary" (click)="printCustomerSheet()">Ver em PDF</button>
        <button pButton type="button" (click)="startEditCustomer()" [disabled]="loading() || !canWrite()">Editar</button>
        <button pButton
          type="button"
          class="warning"
          (click)="inactivateCustomer(selected)"
          [disabled]="loading() || !canWrite() || selected.lifecycle_stage === 'INACTIVE'"
        >
          Inativar
        </button>
        <button pButton type="button" class="danger" (click)="deleteCustomer(selected)" [disabled]="loading() || !canWrite()">
          Excluir
        </button>
        <button pButton type="button" class="secondary" (click)="closeCustomer()" [disabled]="loading()">Fechar</button>
      </div>
    </header>

    <div class="detail-grid" *ngIf="!editing()">
      <p><strong>ID:</strong> #{{ selected.id }}</p>
      <p><strong>Nome:</strong> {{ selected.name }}</p>
      <p><strong>Email:</strong> {{ selected.email }}</p>
      <p><strong>Tipo:</strong> {{ selected.customer_type }}</p>
      <p><strong>CPF:</strong> {{ selected.cpf || '-' }}</p>
      <p><strong>CNPJ:</strong> {{ selected.cnpj || '-' }}</p>
      <p><strong>Telefone:</strong> {{ selected.phone || '-' }}</p>
      <p><strong>WhatsApp:</strong> {{ selected.whatsapp || '-' }}</p>
      <p><strong>CEP:</strong> {{ selected.zip_code || '-' }}</p>
      <p><strong>Endereço:</strong> {{ selected.street || '-' }}, {{ selected.street_number || '-' }}</p>
      <p><strong>Bairro:</strong> {{ selected.neighborhood || '-' }}</p>
      <p><strong>Cidade/UF:</strong> {{ selected.city || '-' }}/{{ selected.state || '-' }}</p>
      <p><strong>Complemento:</strong> {{ selected.address_complement || '-' }}</p>
      <p><strong>Segmento:</strong> {{ getIndustryLabel(selected.industry) }}</p>
      <p><strong>Origem:</strong> {{ getLeadSourceLabel(selected.lead_source) }}</p>
      <p class="field-full"><strong>Observações:</strong> {{ selected.notes || '-' }}</p>
    </div>

    <div *ngIf="(selected.contacts || []).length > 0 && !editing()" class="top-gap">
      <h3>Contatos</h3>
      <p-table class="table compact-table" [value]="selected.contacts || []" responsiveLayout="scroll">
        <ng-template pTemplate="header">
          <tr>
            <th>Nome</th>
            <th>E-mail</th>
            <th>Telefone</th>
            <th>Cargo</th>
            <th>Primário</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-c>
          <tr>
            <td>{{ c.name }}</td>
            <td>{{ c.email || '-' }}</td>
            <td>{{ c.phone || '-' }}</td>
            <td>{{ c.role || '-' }}</td>
            <td>{{ c.is_primary ? 'Sim' : 'Não' }}</td>
          </tr>
        </ng-template>
      </p-table>
    </div>

    <div *ngIf="editing()" class="top-gap">
      <p class="muted">Campos com <strong>*</strong> são obrigatórios.</p>
      <div class="form-grid">
        <label>
          Ação
          <p-select
            [options]="actionOptions"
            optionLabel="label"
            optionValue="value"
            [ngModel]="editAction()"
            (ngModelChange)="editAction.set($event)"
            [disabled]="loading() || !canWrite()"
            placeholder="Selecione a ação"
          ></p-select>
        </label>
        <label>
          Tipo de cliente *
          <select [(ngModel)]="editForm.customer_type" (ngModelChange)="setEditType($event)" [disabled]="loading() || !canWrite()">
            <option value="INDIVIDUAL">Pessoa Física</option>
            <option value="COMPANY">Pessoa Jurídica</option>
          </select>
        </label>

        <label>
          Nome *
          <input pInputText type="text" [(ngModel)]="editForm.name" [disabled]="loading() || !canWrite()" />
        </label>

        <label>
          E-mail *
          <input pInputText type="email" [(ngModel)]="editForm.email" [disabled]="loading() || !canWrite()" />
        </label>

        <label *ngIf="editForm.customer_type === 'INDIVIDUAL'">
          CPF *
          <input pInputText type="text" [(ngModel)]="editForm.cpf" [disabled]="loading() || !canWrite()" />
        </label>

        <label *ngIf="editForm.customer_type === 'COMPANY'">
          CNPJ *
          <input pInputText type="text" [(ngModel)]="editForm.cnpj" [disabled]="loading() || !canWrite()" />
        </label>

        <label class="cep-field">
          CEP *
          <div class="inline-field">
            <input pInputText type="text" [(ngModel)]="editForm.zip_code" (blur)="lookupEditCep()" [disabled]="loading() || editCepLoading() || !canWrite()" />
            <button pButton type="button" class="secondary" (click)="lookupEditCep()" [disabled]="loading() || editCepLoading() || !canWrite()">Buscar</button>
          </div>
          <small *ngIf="editCepLoading()" class="muted">Consultando CEP...</small>
          <small *ngIf="editCepError()" class="error">{{ editCepError() }}</small>
        </label>

        <label>
          Endereço *
          <input pInputText type="text" [(ngModel)]="editForm.street" [disabled]="loading() || !canWrite()" />
        </label>

        <label>
          Número *
          <input pInputText type="text" [(ngModel)]="editForm.street_number" [disabled]="loading() || !canWrite()" />
        </label>

        <label>
          Complemento
          <input pInputText type="text" [(ngModel)]="editForm.address_complement" [disabled]="loading() || !canWrite()" />
        </label>

        <label>
          Bairro *
          <input pInputText type="text" [(ngModel)]="editForm.neighborhood" [disabled]="loading() || !canWrite()" />
        </label>

        <label>
          Cidade *
          <input pInputText type="text" [(ngModel)]="editForm.city" [disabled]="loading() || !canWrite()" />
        </label>

        <label>
          Estado/UF *
          <input pInputText type="text" [(ngModel)]="editForm.state" [disabled]="loading() || !canWrite()" />
        </label>

        <label>
          Segmento *
          <select [(ngModel)]="editForm.industry" [disabled]="loading() || !canWrite()">
            <option value="">Selecione...</option>
            <option *ngFor="let opt of industryOptions" [value]="opt.value">{{ opt.label }}</option>
          </select>
        </label>

        <label>
          Origem *
          <select [(ngModel)]="editForm.lead_source" [disabled]="loading() || !canWrite()">
            <option value="">Selecione...</option>
            <option *ngFor="let opt of leadSourceOptions" [value]="opt.value">{{ opt.label }}</option>
          </select>
        </label>

        <label>
          Status
          <select [(ngModel)]="editForm.lifecycle_stage" [disabled]="loading() || !canWrite()">
            <option value="LEAD">LEAD</option>
            <option value="PROSPECT">PROSPECT</option>
            <option value="CUSTOMER">CUSTOMER</option>
            <option value="INACTIVE">INACTIVE</option>
          </select>
        </label>

        <label class="field-full">
          Observações
          <textarea pInputTextarea rows="2" [(ngModel)]="editForm.notes" [disabled]="loading() || !canWrite()"></textarea>
        </label>

        <div class="field-full" *ngIf="editForm.customer_type === 'COMPANY'">
          <h3>Contatos</h3>
          <div class="contacts">
            <div class="contact-card" *ngFor="let c of editForm.contacts; let i = index">
              <div class="contact-header">
                <div class="contact-title">
                  <strong>Contato {{ i + 1 }}</strong>
                  <span class="muted" *ngIf="c.is_primary">Primário</span>
                </div>
                <div class="actions compact">
                  <label class="radio">
                    <input type="radio" name="primary_contact_edit" [checked]="c.is_primary" (change)="markEditPrimary(i)" [disabled]="loading() || !canWrite()" />
                    Primário
                  </label>
                  <button pButton type="button" class="danger ghost" (click)="removeEditContact(i)" [disabled]="loading() || !canWrite()">Remover</button>
                </div>
              </div>

              <div class="form-grid contact-grid">
                <label>
                  Nome *
                  <input pInputText type="text" [(ngModel)]="c.name" [disabled]="loading() || !canWrite()" />
                </label>
                <label>
                  E-mail
                  <input pInputText type="email" [(ngModel)]="c.email" [disabled]="loading() || !canWrite()" />
                </label>
                <label>
                  Telefone
                  <input pInputText type="text" [(ngModel)]="c.phone" [disabled]="loading() || !canWrite()" />
                </label>
                <label>
                  Cargo
                  <input pInputText type="text" [(ngModel)]="c.role" [disabled]="loading() || !canWrite()" />
                </label>
              </div>
            </div>
          </div>

          <div class="actions top-gap">
            <button pButton type="button" (click)="addEditContact()" [disabled]="loading() || !canWrite()">Adicionar contato</button>
          </div>
        </div>
      </div>

      <div class="actions top-gap">
        <button pButton type="button" (click)="saveCustomer()" [disabled]="loading() || !canWrite() || !isEditValid()">Salvar alterações</button>
        <button pButton type="button" class="secondary" (click)="cancelEditCustomer()" [disabled]="loading()">Cancelar</button>
      </div>
    </div>
  </p-card>

  <p-card styleClass="card ai-card" *ngIf="aiResponse() as ai">
    <header class="ai-header">
      <h2>Insights IA</h2>
      <span class="muted">{{ aiEntityLabel() }} | Provider: {{ ai.insights.provider }}</span>
    </header>
    <p><strong>Resumo:</strong> {{ ai.insights.summary }}</p>
    <div class="ai-grid">
      <div>
        <h3>Riscos</h3>
        <ul>
          <li *ngFor="let item of ai.insights.risks">{{ item }}</li>
        </ul>
      </div>
      <div>
        <h3>Oportunidades</h3>
        <ul>
          <li *ngFor="let item of ai.insights.opportunities">{{ item }}</li>
        </ul>
      </div>
      <div>
        <h3>Próximas ações</h3>
        <ul>
          <li *ngFor="let item of ai.insights.next_actions">{{ item }}</li>
        </ul>
      </div>
    </div>
  </p-card>
</section>
