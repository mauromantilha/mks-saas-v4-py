<section class="tenant-wrap sakai-page">
  <header class="page-header surface-card">
    <div class="title-wrap">
      <p class="badge">Estratégia & Comercial</p>
      <h1>Projetos Especiais</h1>
      <p class="subtitle">Criação, execução e fechamento de projetos com atividades, SWOT e documentos.</p>
    </div>
    <i class="pi pi-briefcase header-icon" aria-hidden="true"></i>
    <button pButton type="button" (click)="bootstrap()" [disabled]="loading()">Atualizar</button>
  </header>

  <p *ngIf="loading()" class="muted">Carregando...</p>
  <p *ngIf="error()" class="error">{{ error() }}</p>
  <p *ngIf="notice()" class="notice">{{ notice() }}</p>

  <p-card styleClass="card">
    <h2>Criar Projeto</h2>
    <p class="field-label">Tipo de vínculo do cliente</p>
    <div class="toggle-row">
      <label>
        <p-radioButton name="customerMode" [value]="true" [ngModel]="useExistingCustomer()" (ngModelChange)="changeCustomerMode(!!$event)"></p-radioButton>
        Cliente existente
      </label>
      <label>
        <p-radioButton name="customerMode" [value]="false" [ngModel]="useExistingCustomer()" (ngModelChange)="changeCustomerMode(!!$event)"></p-radioButton>
        Novo cliente (simplificado)
      </label>
    </div>

    <div class="form-grid">
      <label>
        Nome da ação
        <p-select
          [options]="actionOptions"
          optionLabel="label"
          optionValue="value"
          [ngModel]="projectAction()"
          (ngModelChange)="projectAction.set($event)"
          [disabled]="loading() || !canWrite()"
          placeholder="Selecione a ação"
        ></p-select>
      </label>
      <label *ngIf="useExistingCustomer()">
        Cliente
        <p-select
          [options]="customerSelectOptions()"
          [ngModel]="customerId()"
          (ngModelChange)="customerId.set($event ? +$event : null)"
          placeholder="Selecione..."
        ></p-select>
      </label>

      <label *ngIf="!useExistingCustomer()">
        Nome cliente
        <input pInputText type="text" [ngModel]="newCustomerName()" (ngModelChange)="newCustomerName.set($event)" />
      </label>
      <label *ngIf="!useExistingCustomer()">
        CPF/CNPJ
        <input pInputText type="text" [ngModel]="newCustomerDocument()" (ngModelChange)="newCustomerDocument.set($event)" />
      </label>
      <label *ngIf="!useExistingCustomer()">
        Telefone
        <input pInputText type="text" [ngModel]="newCustomerPhone()" (ngModelChange)="newCustomerPhone.set($event)" />
      </label>
      <label *ngIf="!useExistingCustomer()">
        E-mail
        <input pInputText type="email" [ngModel]="newCustomerEmail()" (ngModelChange)="newCustomerEmail.set($event)" />
      </label>

      <label>
        Nome do projeto
        <input pInputText type="text" [ngModel]="projectName()" (ngModelChange)="projectName.set($event)" />
      </label>
      <label>
        Tipo de projeto
        <p-select
          [options]="projectTypeOptions"
          optionLabel="label"
          optionValue="value"
          [ngModel]="projectType()"
          (ngModelChange)="projectType.set($event)"
        ></p-select>
      </label>
      <label>
        Owner
        <p-select
          [options]="memberOwnerOptions()"
          [ngModel]="ownerId()"
          (ngModelChange)="ownerId.set($event ? +$event : null)"
          placeholder="Selecione..."
        ></p-select>
      </label>
      <label>
        Data início
        <input pInputText type="date" [ngModel]="startDate()" (ngModelChange)="startDate.set($event)" />
      </label>
      <label>
        Data entrega
        <input pInputText type="date" [ngModel]="dueDate()" (ngModelChange)="dueDate.set($event)" />
      </label>

      <label>
        SWOT - Strengths
        <textarea pInputTextarea rows="2" [ngModel]="swotStrengths()" (ngModelChange)="swotStrengths.set($event)"></textarea>
      </label>
      <label>
        SWOT - Weaknesses
        <textarea pInputTextarea rows="2" [ngModel]="swotWeaknesses()" (ngModelChange)="swotWeaknesses.set($event)"></textarea>
      </label>
      <label>
        SWOT - Opportunities
        <textarea pInputTextarea rows="2" [ngModel]="swotOpportunities()" (ngModelChange)="swotOpportunities.set($event)"></textarea>
      </label>
      <label>
        SWOT - Threats
        <textarea pInputTextarea rows="2" [ngModel]="swotThreats()" (ngModelChange)="swotThreats.set($event)"></textarea>
      </label>
      <label class="field-full">
        Notas
        <textarea pInputTextarea rows="2" [ngModel]="notes()" (ngModelChange)="notes.set($event)"></textarea>
      </label>
    </div>

    <div class="actions top-gap">
      <button pButton type="button" (click)="createProject()" [disabled]="loading() || !canWrite()">Criar projeto</button>
    </div>
  </p-card>

  <p-card styleClass="card">
    <h2>Projetos</h2>
    <div class="form-grid one-line">
      <label>
        Status
        <p-select
          [options]="statusFilterOptions"
          optionLabel="label"
          optionValue="value"
          [ngModel]="statusFilter()"
          (ngModelChange)="statusFilter.set($event)"
        ></p-select>
      </label>
      <div class="actions align-end">
        <button pButton type="button" (click)="loadProjects()" [disabled]="loading()">Filtrar</button>
      </div>
    </div>

    <p-table class="table" *ngIf="projects().length > 0; else noProjects" [value]="projects()" responsiveLayout="scroll">
      <ng-template pTemplate="header">
        <tr>
          <th>ID</th>
          <th>Projeto</th>
          <th>Cliente</th>
          <th>Tipo</th>
          <th>Status</th>
          <th>Entrega</th>
          <th>Ações</th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-p>
        <tr>
          <td>#{{ p.id }}</td>
          <td>{{ p.name }}</td>
          <td>{{ p.customer_name || p.prospect_name || '-' }}</td>
          <td>{{ p.project_type }}</td>
          <td><span class="pill" [class.warn]="p.status==='CLOSED_LOST'" [class.ok]="p.status==='CLOSED_WON'">{{ p.status }}</span></td>
          <td>{{ p.due_date | date:'shortDate' }}</td>
          <td>
            <div class="actions compact">
              <button pButton type="button" class="secondary" (click)="openProject(p.id)">Detalhes</button>
              <button pButton type="button" class="danger" (click)="deleteProject(p)" [disabled]="loading() || !canWrite()">Excluir</button>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
    <ng-template #noProjects><p class="muted">Nenhum projeto cadastrado.</p></ng-template>
  </p-card>

  <p-card styleClass="card" *ngIf="selectedProject() as project">
    <header class="detail-header">
      <div>
        <h2>Projeto #{{ project.id }} - {{ project.name }}</h2>
        <p class="muted">Cliente: {{ project.customer_name || project.prospect_name || '-' }} | Status: {{ project.status }}</p>
      </div>
      <div class="actions">
        <button pButton type="button" (click)="saveProjectChanges(project)" [disabled]="loading() || !canWrite()">Salvar</button>
        <button pButton type="button" class="warning" (click)="updateProjectStatus('CLOSED')" [disabled]="loading() || !canWrite()">Fechar</button>
        <button pButton type="button" class="ok-btn" (click)="updateProjectStatus('CLOSED_WON')" [disabled]="loading() || !canWrite()">Ganho</button>
        <button pButton type="button" class="danger" (click)="updateProjectStatus('CLOSED_LOST')" [disabled]="loading() || !canWrite()">Perdido</button>
        <button pButton type="button" class="secondary" (click)="closeProject()" [disabled]="loading()">Fechar painel</button>
      </div>
    </header>

    <div class="form-grid">
      <label>
        Nome projeto
        <input pInputText type="text" [(ngModel)]="project.name" [disabled]="loading() || !canWrite()" />
      </label>
      <label>
        Tipo
        <p-select
          [options]="projectTypeOptions"
          optionLabel="label"
          optionValue="value"
          [(ngModel)]="project.project_type"
          [disabled]="loading() || !canWrite()"
        ></p-select>
      </label>
      <label>
        Owner
        <p-select
          [options]="memberSimpleOptions()"
          [(ngModel)]="project.owner"
          [disabled]="loading() || !canWrite()"
          placeholder="Selecione..."
        ></p-select>
      </label>
      <label>
        Início
        <input pInputText type="date" [(ngModel)]="project.start_date" [disabled]="loading() || !canWrite()" />
      </label>
      <label>
        Entrega
        <input pInputText type="date" [(ngModel)]="project.due_date" [disabled]="loading() || !canWrite()" />
      </label>
      <label class="field-full" *ngIf="project.status === 'CLOSED_LOST'">
        Motivo perda
        <textarea pInputTextarea rows="2" [ngModel]="lossReason()" (ngModelChange)="lossReason.set($event)" [disabled]="loading() || !canWrite()"></textarea>
      </label>
      <label>
        SWOT - Strengths
        <textarea pInputTextarea rows="2" [(ngModel)]="project.swot_strengths" [disabled]="loading() || !canWrite()"></textarea>
      </label>
      <label>
        SWOT - Weaknesses
        <textarea pInputTextarea rows="2" [(ngModel)]="project.swot_weaknesses" [disabled]="loading() || !canWrite()"></textarea>
      </label>
      <label>
        SWOT - Opportunities
        <textarea pInputTextarea rows="2" [(ngModel)]="project.swot_opportunities" [disabled]="loading() || !canWrite()"></textarea>
      </label>
      <label>
        SWOT - Threats
        <textarea pInputTextarea rows="2" [(ngModel)]="project.swot_threats" [disabled]="loading() || !canWrite()"></textarea>
      </label>
      <label class="field-full">
        Notas
        <textarea pInputTextarea rows="2" [(ngModel)]="project.notes" [disabled]="loading() || !canWrite()"></textarea>
      </label>
    </div>

    <div class="split-grid top-gap">
      <p-card styleClass="card inner">
        <h3>Atividades</h3>
        <div class="form-grid">
          <label>
            Título
            <input pInputText type="text" [ngModel]="activityTitle()" (ngModelChange)="activityTitle.set($event)" [disabled]="loading() || !canWrite()" />
          </label>
          <label>
            Entrega
            <input pInputText type="date" [ngModel]="activityDueDate()" (ngModelChange)="activityDueDate.set($event)" [disabled]="loading() || !canWrite()" />
          </label>
          <label class="field-full">
            Descrição
            <textarea pInputTextarea rows="2" [ngModel]="activityDescription()" (ngModelChange)="activityDescription.set($event)" [disabled]="loading() || !canWrite()"></textarea>
          </label>
        </div>
        <div class="actions top-gap">
          <button pButton type="button" (click)="addActivity()" [disabled]="loading() || !canWrite()">Adicionar atividade</button>
        </div>

        <p-table class="table compact-table" *ngIf="project.activities.length > 0" [value]="project.activities" responsiveLayout="scroll">
          <ng-template pTemplate="header"><tr><th>Título</th><th>Entrega</th><th>Status</th><th></th></tr></ng-template>
          <ng-template pTemplate="body" let-a>
            <tr>
              <td>{{ a.title }}</td>
              <td>{{ a.due_date ? (a.due_date | date:'shortDate') : '-' }}</td>
              <td>{{ a.status }}</td>
              <td>
                <div class="actions compact">
                  <button pButton type="button" class="secondary" (click)="toggleActivityDone(a)" [disabled]="loading() || !canWrite()">{{ a.status === 'DONE' ? 'Reabrir' : 'Concluir' }}</button>
                  <button pButton type="button" class="danger" (click)="removeActivity(a)" [disabled]="loading() || !canWrite()">Excluir</button>
                </div>
              </td>
            </tr>
          </ng-template>
        </p-table>
      </p-card>

      <p-card styleClass="card inner">
        <h3>Documentos</h3>
        <label class="field-label" for="project-documents-upload">Arquivos do projeto</label>
        <input id="project-documents-upload" type="file" multiple (change)="uploadDocuments($event)" [disabled]="loading() || !canWrite()" />
        <p-table class="table compact-table" *ngIf="project.documents.length > 0" [value]="project.documents" responsiveLayout="scroll">
          <ng-template pTemplate="header"><tr><th>Título</th><th>Arquivo</th><th>Enviado por</th><th></th></tr></ng-template>
          <ng-template pTemplate="body" let-d>
            <tr>
              <td>{{ d.title }}</td>
              <td><a [href]="d.file_url || d.file" target="_blank" rel="noopener">Abrir</a></td>
              <td>{{ d.uploaded_by_username || '-' }}</td>
              <td>
                <button pButton type="button" class="danger" (click)="removeDocument(d)" [disabled]="loading() || !canWrite()">Excluir</button>
              </td>
            </tr>
          </ng-template>
        </p-table>
      </p-card>
    </div>
  </p-card>
</section>
