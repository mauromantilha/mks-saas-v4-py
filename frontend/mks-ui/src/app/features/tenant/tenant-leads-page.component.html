<section class="tenant-wrap sakai-page">
  <header class="page-header surface-card">
    <div class="title-wrap">
      <p class="badge">CRM</p>
      <h1 class="title">Leads</h1>
      <p class="subtitle">
        Entrada por webhook/API/importação e gestão do primeiro contato com SLA e IA.
      </p>
    </div>
    <i class="pi pi-users header-icon" aria-hidden="true"></i>
    <div class="header-actions">
      <div class="tabs">
        <button pButton
          type="button"
          (click)="setMode('KANBAN')"
          [class.active]="mode() === 'KANBAN'"
          [class.mode-green]="mode() === 'KANBAN'"
        >
          Kanban
        </button>
        <button pButton
          type="button"
          (click)="setMode('LIST')"
          [class.active]="mode() === 'LIST'"
          [class.mode-green]="mode() === 'LIST'"
        >
          Lista
        </button>
      </div>
      <button pButton type="button" (click)="load()" [disabled]="loading()">Atualizar</button>
    </div>
  </header>

  <p *ngIf="loading()" class="muted">Carregando...</p>
  <p *ngIf="error()" class="error">{{ error() }}</p>
  <p *ngIf="notice()" class="notice">{{ notice() }}</p>

  <p-card styleClass="card form-card">
    <h2>Novo Lead</h2>
    <p class="muted">
      Ao salvar, o backend aplica IA automaticamente (score + próximos passos). Se houver
      CNPJ, tenta enriquecimento via endpoint configurado.
    </p>

    <div class="form-grid">
      <label>
        Ação
        <p-select
          [options]="actionOptions"
          optionLabel="label"
          optionValue="value"
          [ngModel]="leadAction()"
          (ngModelChange)="leadAction.set($event)"
          [disabled]="loading() || !canWrite()"
          placeholder="Selecione a ação"
        ></p-select>
      </label>
      <label>
        Origem (obrigatório)
        <p-select
          [options]="leadSourceOptions"
          optionLabel="label"
          optionValue="value"
          [ngModel]="leadSource()"
          (ngModelChange)="leadSource.set($event)"
          [disabled]="loading() || !canWrite()"
          placeholder="Selecione a origem do lead"
        ></p-select>
      </label>
      <label>
        Contato
        <input pInputText
          type="text"
          [ngModel]="leadFullName()"
          (ngModelChange)="leadFullName.set($event)"
          [disabled]="loading() || !canWrite()"
          placeholder="Nome do decisor"
        />
      </label>
      <label>
        Empresa
        <input pInputText
          type="text"
          [ngModel]="leadCompanyName()"
          (ngModelChange)="leadCompanyName.set($event)"
          [disabled]="loading() || !canWrite()"
          placeholder="Razão social / fantasia"
        />
      </label>
      <label>
        E-mail
        <input pInputText
          type="email"
          [ngModel]="leadEmail()"
          (ngModelChange)="leadEmail.set($event)"
          [disabled]="loading() || !canWrite()"
        />
      </label>
      <label>
        Telefone
        <input pInputText
          type="text"
          [ngModel]="leadPhone()"
          (ngModelChange)="leadPhone.set($event)"
          [disabled]="loading() || !canWrite()"
        />
      </label>
      <label>
        CNPJ ou CPF
        <input pInputText
          type="text"
          [ngModel]="leadCnpj()"
          (ngModelChange)="leadCnpj.set($event)"
          [disabled]="loading() || !canWrite()"
          placeholder="00.000.000/0001-00 ou 000.000.000-00"
        />
      </label>
      <label>
        Produtos de interesse
        <input pInputText
          type="text"
          [ngModel]="leadProductsOfInterest()"
          (ngModelChange)="leadProductsOfInterest.set($event)"
          [disabled]="loading() || !canWrite()"
          placeholder="Auto, Vida, Frotas..."
        />
      </label>
      <label>
        Orçamento estimado
        <input pInputText
          type="number"
          [ngModel]="leadEstimatedBudget()"
          (ngModelChange)="leadEstimatedBudget.set($event)"
          [disabled]="loading() || !canWrite()"
        />
      </label>
      <label class="field-full">
        Observações
        <textarea pInputTextarea
          rows="2"
          [ngModel]="leadNotes()"
          (ngModelChange)="leadNotes.set($event)"
          [disabled]="loading() || !canWrite()"
        ></textarea>
      </label>
    </div>

    <div class="actions top-gap">
      <button pButton type="button" (click)="createLead()" [disabled]="loading() || !canWrite()">
        Criar lead
      </button>
    </div>
  </p-card>

  <ng-container *ngIf="mode() === 'KANBAN'">
    <section class="kanban">
      <article
        *ngFor="let col of columns"
        class="column"
        (dragover)="onDragOver($event)"
        (drop)="onDrop($event, col.key)"
      >
        <header class="column-header">
          <h3>{{ col.label }}</h3>
          <span class="count">{{ leadsForColumn(col.key).length }}</span>
        </header>
        <p class="help">{{ col.help }}</p>

        <div class="cards">
          <div
            class="lead-card"
            *ngFor="let lead of leadsForColumn(col.key)"
            draggable="true"
            (dragstart)="onDragStart($event, lead)"
          >
            <div class="lead-title">
              <strong>#{{ lead.id }}</strong>
              <span class="score" *ngIf="lead.qualification_score !== null">
                Score {{ lead.qualification_score }}
              </span>
            </div>
            <p class="lead-sub">
              {{ lead.company_name || lead.full_name || lead.source }}
            </p>
            <p class="lead-meta">
              <span>{{ lead.email || "-" }}</span>
              <span>{{ lead.cnpj || "-" }}</span>
            </p>

            <div class="actions compact">
              <button pButton
                type="button"
                (click)="generateInsights(lead)"
                [disabled]="loading()"
              >
                IA
              </button>
              <button pButton
                type="button"
                (click)="enrichCnpj(lead)"
                [disabled]="loading() || !canWrite()"
              >
                Enriquecer
              </button>
            </div>
          </div>
        </div>
      </article>
    </section>
  </ng-container>

  <ng-container *ngIf="mode() === 'LIST'">
    <p-card styleClass="card list-card">
      <h2>Lista de Leads</h2>
      <p-table
        class="table list-table"
        *ngIf="leads().length > 0"
        [value]="leads()"
        responsiveLayout="scroll"
      >
        <ng-template pTemplate="header">
          <tr>
            <th>ID</th>
            <th>Origem</th>
            <th>Empresa</th>
            <th>Status</th>
            <th>Score</th>
            <th>CNPJ</th>
            <th>Ações</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-lead>
          <tr>
            <td>{{ lead.id }}</td>
            <td>{{ lead.source }}</td>
            <td>{{ lead.company_name || "-" }}</td>
            <td>{{ lead.status }}</td>
            <td>{{ lead.qualification_score ?? "-" }}</td>
            <td>{{ lead.cnpj || "-" }}</td>
            <td>
              <div class="actions compact">
                <button pButton type="button" (click)="generateInsights(lead)" [disabled]="loading()">
                  IA
                </button>
                <button pButton
                  type="button"
                  (click)="enrichCnpj(lead)"
                  [disabled]="loading() || !canWrite()"
                >
                  Enriquecer
                </button>
              </div>
            </td>
          </tr>
        </ng-template>
      </p-table>
      <p *ngIf="leads().length === 0" class="muted">Nenhum lead encontrado.</p>
    </p-card>
  </ng-container>

  <p-card styleClass="card ai-card" *ngIf="aiResponse() as ai">
    <header class="ai-header">
      <h2>Insights IA</h2>
      <span class="muted">{{ aiEntityLabel() }} | Provider: {{ ai.insights.provider }}</span>
    </header>
    <p><strong>Resumo:</strong> {{ ai.insights.summary }}</p>
    <div class="ai-grid">
      <div>
        <h3>Riscos</h3>
        <ul>
          <li *ngFor="let item of ai.insights.risks">{{ item }}</li>
        </ul>
      </div>
      <div>
        <h3>Oportunidades</h3>
        <ul>
          <li *ngFor="let item of ai.insights.opportunities">{{ item }}</li>
        </ul>
      </div>
      <div>
        <h3>Próximas ações</h3>
        <ul>
          <li *ngFor="let item of ai.insights.next_actions">{{ item }}</li>
        </ul>
      </div>
    </div>
  </p-card>
</section>
