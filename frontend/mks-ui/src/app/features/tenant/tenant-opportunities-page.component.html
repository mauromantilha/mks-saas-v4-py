<section class="tenant-wrap">
  <header class="page-header">
    <div>
      <p class="badge">CRM</p>
      <h1>Oportunidades</h1>
      <p class="subtitle">
        Pipeline detalhado com etapas, métricas e handover automático ao fechar como "Ganha".
      </p>
    </div>
    <div class="header-actions">
      <div class="tabs">
        <button pButton
          type="button"
          (click)="setMode('KANBAN')"
          [class.active]="mode() === 'KANBAN'"
        >
          Kanban
        </button>
        <button pButton
          type="button"
          (click)="setMode('LIST')"
          [class.active]="mode() === 'LIST'"
        >
          Lista
        </button>
      </div>
      <button pButton type="button" (click)="load()" [disabled]="loading()">Atualizar</button>
    </div>
  </header>

  <p *ngIf="loading()" class="muted">Carregando...</p>
  <p *ngIf="error()" class="error">{{ error() }}</p>
  <p *ngIf="notice()" class="notice">{{ notice() }}</p>

  <article class="card">
    <h2>Nova Oportunidade</h2>
    <p class="muted">
      Dica: leads convertidos geram oportunidades automaticamente. Aqui é para criação manual.
    </p>

    <div class="form-grid">
      <label>
        Cliente
        <select
          [ngModel]="customerId()"
          (ngModelChange)="customerId.set($event)"
          [disabled]="loading() || !canWrite()"
        >
          <option value="">Selecione...</option>
          <option *ngFor="let c of customers()" [value]="c.id">
            #{{ c.id }} - {{ c.name }}
          </option>
        </select>
      </label>
      <label class="field-full">
        Título
        <input pInputText
          type="text"
          [ngModel]="title()"
          (ngModelChange)="title.set($event)"
          [disabled]="loading() || !canWrite()"
          placeholder="Ex.: Seguro frota - Transportadora XPTO"
        />
      </label>
      <label>
        Valor estimado
        <input pInputText
          type="number"
          [ngModel]="amount()"
          (ngModelChange)="amount.set($event)"
          [disabled]="loading() || !canWrite()"
        />
      </label>
      <label>
        Estágio
        <select
          [ngModel]="stage()"
          (ngModelChange)="stage.set($event)"
          [disabled]="loading() || !canWrite()"
        >
          <option *ngFor="let col of columns" [value]="col.stage">{{ col.label }}</option>
        </select>
      </label>
    </div>

    <div class="actions top-gap">
      <button pButton
        type="button"
        (click)="createOpportunity()"
        [disabled]="loading() || !canWrite()"
      >
        Criar oportunidade
      </button>
    </div>
  </article>

  <ng-container *ngIf="mode() === 'KANBAN'">
    <section class="kanban">
      <article
        *ngFor="let col of columns"
        class="column"
        (dragover)="onDragOver($event)"
        (drop)="onDrop($event, col.stage)"
      >
        <header class="column-header">
          <h3>{{ col.label }}</h3>
          <span class="count">{{ opportunitiesForStage(col.stage).length }}</span>
        </header>
        <p class="help">{{ col.help }}</p>

        <div class="cards">
          <div
            class="opp-card"
            *ngFor="let opp of opportunitiesForStage(col.stage)"
            draggable="true"
            (dragstart)="onDragStart($event, opp)"
          >
            <div class="opp-title">
              <strong>#{{ opp.id }}</strong>
              <span class="amount">{{ formatCurrency(opp.amount) }}</span>
            </div>
            <p class="opp-sub">{{ opp.title }}</p>
            <p class="opp-meta">
              Cliente #{{ opp.customer }} | Prob. {{ opp.closing_probability }}%
            </p>
            <div class="actions compact">
              <button pButton type="button" (click)="generateInsights(opp)" [disabled]="loading()">
                IA
              </button>
            </div>
          </div>
        </div>
      </article>
    </section>
  </ng-container>

  <ng-container *ngIf="mode() === 'LIST'">
    <article class="card">
      <h2>Lista de Oportunidades</h2>
      <table class="table" *ngIf="opportunities().length > 0">
        <thead>
          <tr>
            <th>ID</th>
            <th>Título</th>
            <th>Estágio</th>
            <th>Valor</th>
            <th>Prob.</th>
            <th>Cliente</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let opp of opportunities()">
            <td>{{ opp.id }}</td>
            <td>{{ opp.title }}</td>
            <td>{{ opp.stage }}</td>
            <td>{{ formatCurrency(opp.amount) }}</td>
            <td>{{ opp.closing_probability }}%</td>
            <td>#{{ opp.customer }}</td>
            <td>
              <div class="actions compact">
                <button pButton type="button" (click)="generateInsights(opp)" [disabled]="loading()">
                  IA
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
      <p *ngIf="opportunities().length === 0" class="muted">Nenhuma oportunidade encontrada.</p>
    </article>
  </ng-container>

  <article class="card ai-card" *ngIf="aiResponse() as ai">
    <header class="ai-header">
      <h2>Insights IA</h2>
      <span class="muted">{{ aiEntityLabel() }} | Provider: {{ ai.insights.provider }}</span>
    </header>
    <p><strong>Resumo:</strong> {{ ai.insights.summary }}</p>
    <div class="ai-grid">
      <div>
        <h3>Riscos</h3>
        <ul>
          <li *ngFor="let item of ai.insights.risks">{{ item }}</li>
        </ul>
      </div>
      <div>
        <h3>Oportunidades</h3>
        <ul>
          <li *ngFor="let item of ai.insights.opportunities">{{ item }}</li>
        </ul>
      </div>
      <div>
        <h3>Próximas ações</h3>
        <ul>
          <li *ngFor="let item of ai.insights.next_actions">{{ item }}</li>
        </ul>
      </div>
    </div>
  </article>
</section>

