<p-toast position="top-right"></p-toast>

<section class="sales-flow-page sales-flow-aura-light sakai-page">
  <header class="sales-flow-header surface-card">
    <div class="title-wrap">
      <p class="eyebrow">Estratégia & Comercial</p>
      <h1>Fluxo Comercial</h1>
      <p class="subtitle">
        Gestão diária de indicadores, atividades e agenda comercial do tenant.
      </p>
    </div>
    <i class="pi pi-briefcase header-icon" aria-hidden="true"></i>

    <div class="header-actions">
      <button
        pButton
        type="button"
        class="btn-primary"
        [disabled]="loadingSummary() || loadingAgenda() || loadingEntities()"
        (click)="refreshPage()"
      >
        Atualizar
      </button>
    </div>
  </header>

  <div *ngIf="session() as s" class="session-strip surface-card">
    <span><strong>Tenant:</strong> {{ s.tenantCode }}</span>
    <span><strong>Usuário:</strong> {{ s.username }}</span>
    <span><strong>Perfil:</strong> {{ s.role || "-" }}</span>
  </div>

  <ng-container *ngIf="permissionsLoading(); else permissionsReady">
    <section class="kpi-grid">
      <p-card class="kpi-card" *ngFor="let _ of [1, 2, 3, 4, 5, 6, 7, 8]">
        <p-skeleton width="3rem" height="3rem"></p-skeleton>
        <p-skeleton width="9rem" height="1rem" styleClass="mt-2"></p-skeleton>
        <p-skeleton width="7rem" height="1.5rem" styleClass="mt-2"></p-skeleton>
      </p-card>
    </section>
  </ng-container>

  <ng-template #permissionsReady>
    <p-card *ngIf="!canReadSalesFlow()" styleClass="state-card state-error">
      <h2>Acesso bloqueado</h2>
      <p>Seu usuário não possui capability para visualizar o Fluxo Comercial.</p>
      <p class="muted" *ngIf="permissionError()">{{ permissionError() }}</p>
    </p-card>

    <ng-container *ngIf="canReadSalesFlow()">
      <section class="kpi-grid" *ngIf="loadingSummary(); else kpiLoaded">
        <p-card class="kpi-card" *ngFor="let _ of [1, 2, 3, 4, 5, 6, 7, 8]">
          <p-skeleton width="3rem" height="3rem"></p-skeleton>
          <p-skeleton width="9rem" height="1rem" styleClass="mt-2"></p-skeleton>
          <p-skeleton width="7rem" height="1.5rem" styleClass="mt-2"></p-skeleton>
        </p-card>
      </section>

      <ng-template #kpiLoaded>
        <section class="kpi-grid" *ngIf="kpiCards().length > 0; else emptyKpi">
          <p-card
            styleClass="kpi-card surface-card border-1 border-blue-200 shadow-none"
            *ngFor="let card of kpiCards()"
          >
            <div class="kpi-head">
              <i [class]="card.icon"></i>
              <span class="kpi-label text-600">{{ card.label }}</span>
            </div>
            <strong class="kpi-value text-900">{{ card.value }}</strong>
          </p-card>
        </section>
      </ng-template>

      <ng-template #emptyKpi>
        <p-card styleClass="state-card state-empty">
          <h2>Sem indicadores</h2>
          <p>Nenhum dado de resumo retornado para o tenant no momento.</p>
        </p-card>
      </ng-template>

      <section class="workspace-grid">
        <p-card styleClass="panel-card surface-card border-1 border-blue-200 shadow-none">
          <h2>Criar atividade</h2>
          <p class="muted panel-note">
            Permissão necessária: <code>tenant.activities.manage</code>
          </p>

          <form class="form-grid" [formGroup]="activityForm" (ngSubmit)="submitActivity()">
            <label>
              Tipo
              <p-select
                formControlName="type"
                [options]="activityTypeOptions"
                optionLabel="label"
                optionValue="value"
                placeholder="Selecione o tipo de atividade"
                [disabled]="savingActivity() || !canManageActivities()"
              ></p-select>
            </label>

            <label>
              Prioridade
              <p-select
                formControlName="priority"
                [options]="activityPriorityOptions"
                optionLabel="label"
                optionValue="value"
                placeholder="Selecione a prioridade"
                [disabled]="savingActivity() || !canManageActivities()"
              ></p-select>
            </label>

            <label>
              Origem
              <p-select
                formControlName="origin"
                [options]="originOptions"
                optionLabel="label"
                optionValue="value"
                placeholder="Selecione a origem"
                [disabled]="savingActivity() || loadingEntities() || !canManageActivities()"
              ></p-select>
            </label>

            <label class="field-full">
              Lead/Oportunidade/Projeto/Cliente
              <p-autocomplete
                formControlName="target"
                [suggestions]="targetSuggestions()"
                (completeMethod)="onTargetSearch($event)"
                [dropdown]="true"
                dropdownIcon="pi pi-chevron-down"
                [forceSelection]="true"
                optionLabel="label"
                placeholder="Buscar lead / oportunidade / projeto"
                [disabled]="savingActivity() || loadingEntities() || !canManageActivities()"
              ></p-autocomplete>
            </label>

            <div class="field-date">
              <p-floatlabel>
              <p-datepicker
                inputId="sf-startAt"
                formControlName="startAt"
                [showIcon]="true"
                iconDisplay="input"
                [showTime]="true"
                hourFormat="24"
                appendTo="body"
                [disabled]="savingActivity() || !canManageActivities()"
              ></p-datepicker>
              <label for="sf-startAt">Início</label>
              </p-floatlabel>
            </div>

            <div class="field-date">
              <p-floatlabel>
              <p-datepicker
                inputId="sf-endAt"
                formControlName="endAt"
                [showIcon]="true"
                iconDisplay="input"
                [showTime]="true"
                hourFormat="24"
                appendTo="body"
                [disabled]="savingActivity() || !canManageActivities()"
              ></p-datepicker>
              <label for="sf-endAt">Fim</label>
              </p-floatlabel>
            </div>

            <label class="field-full">
              Título
              <input
                pInputText
                type="text"
                formControlName="title"
                [disabled]="savingActivity() || !canManageActivities()"
                placeholder="Ex.: Follow-up cotação transportes"
              />
            </label>

            <label class="field-full">
              Nota
              <textarea
                pInputTextarea
                rows="3"
                formControlName="note"
                [disabled]="savingActivity() || !canManageActivities()"
                placeholder="Observações da atividade"
              ></textarea>
            </label>

            <div class="panel-actions field-full">
              <button
                pButton
                type="submit"
                severity="primary"
                icon="pi pi-check"
                [label]="savingActivity() ? 'Criando...' : 'Criar Atividade'"
                [disabled]="savingActivity() || !canManageActivities()"
              ></button>
            </div>
          </form>
        </p-card>

        <p-card styleClass="panel-card agenda-card surface-card border-1 border-blue-300 shadow-none">
          <h2>Nova Reunião</h2>
          <p class="muted panel-note">
            Convites por email seguem a configuração SMTP do tenant.
          </p>

          <form class="form-grid" [formGroup]="agendaForm" (ngSubmit)="submitAgenda()">
            <label class="field-full">
              Título
              <input
                pInputText
                type="text"
                formControlName="title"
                placeholder="Título da reunião"
                [disabled]="savingAgenda() || !canManageAgenda()"
              />
            </label>

            <div class="field-date">
              <p-floatlabel>
              <p-datepicker
                inputId="sf-agenda-date"
                formControlName="date"
                dateFormat="dd/mm/yy"
                [showIcon]="true"
                iconDisplay="input"
                appendTo="body"
                [disabled]="savingAgenda() || !canManageAgenda()"
              ></p-datepicker>
              <label for="sf-agenda-date">Data</label>
              </p-floatlabel>
            </div>

            <label>
              Horário
              <input
                pInputText
                type="time"
                formControlName="time"
                [disabled]="savingAgenda() || !canManageAgenda()"
              />
            </label>

            <label>
              Nome
              <input
                pInputText
                type="text"
                formControlName="attendeeName"
                placeholder="Nome do participante"
                [disabled]="savingAgenda() || !canManageAgenda()"
              />
            </label>

            <label>
              Email
              <input
                pInputText
                type="email"
                formControlName="attendeeEmail"
                placeholder="Email do participante"
                [disabled]="savingAgenda() || !canManageAgenda()"
              />
            </label>

            <label class="field-full">
              Assunto
              <input
                pInputText
                type="text"
                formControlName="subject"
                placeholder="Assunto da reunião"
                [disabled]="savingAgenda() || !canManageAgenda()"
              />
            </label>

            <label class="toggle-row field-full">
              <span>Enviar convite por email</span>
              <p-toggleswitch
                formControlName="sendInvite"
                [disabled]="savingAgenda() || !canManageAgenda()"
              ></p-toggleswitch>
            </label>

            <div class="panel-actions field-full">
              <button
                pButton
                type="submit"
                severity="success"
                icon="pi pi-calendar-plus"
                [label]="savingAgenda() ? 'Agendando...' : 'Agendar'"
                [disabled]="savingAgenda() || !canManageAgenda()"
              ></button>
            </div>
          </form>
        </p-card>
      </section>

      <p-card styleClass="panel-card table-card surface-card border-1 border-blue-200 shadow-none">
        <div class="table-header">
          <h2>Próximas Reuniões</h2>
          <span class="muted">Atualização automática a cada 60s</span>
        </div>

        <p-table
          styleClass="table-light"
          [value]="meetingItems()"
          [loading]="loadingAgenda()"
          [paginator]="meetingItems().length > 10"
          [rows]="10"
          responsiveLayout="scroll"
          size="small"
        >
          <ng-template pTemplate="header">
            <tr>
              <th>Título</th>
              <th>Data</th>
              <th>Horário</th>
              <th>Status</th>
              <th>Ações</th>
            </tr>
          </ng-template>

          <ng-template pTemplate="body" let-item>
            <tr>
              <td>{{ item.title }}</td>
              <td>{{ item.start_at | date: "dd/MM/yyyy" }}</td>
              <td>{{ item.start_at | date: "HH:mm" }}</td>
              <td>
                <p-tag
                  [value]="statusLabel(item.status)"
                  [severity]="statusSeverity(item.status)"
                ></p-tag>
              </td>
              <td>
                <div class="row-actions">
                  <button
                    pButton
                    type="button"
                    size="small"
                    severity="success"
                    [disabled]="
                      !canManageAgenda()
                      || item.status !== 'OPEN'
                      || handlingReminderAction()
                    "
                    (click)="confirmAgenda(item)"
                  >
                    Confirmar
                  </button>
                  <button
                    pButton
                    type="button"
                    size="small"
                    severity="danger"
                    [disabled]="
                      !canManageAgenda()
                      || (item.status !== 'OPEN' && item.status !== 'CONFIRMED')
                      || handlingReminderAction()
                    "
                    (click)="cancelAgenda(item)"
                  >
                    Cancelar
                  </button>
                </div>
              </td>
            </tr>
          </ng-template>

          <ng-template pTemplate="emptymessage">
            <tr>
              <td colspan="5" class="empty-row">Nenhuma reunião encontrada para o período.</td>
            </tr>
          </ng-template>
        </p-table>
      </p-card>

      <p-card styleClass="panel-card table-card mt-4 surface-card border-1 border-blue-200 shadow-none">
        <div class="table-header">
          <h2>Atividades Pendentes</h2>
          <span class="muted">Itens operacionais sem participante definido</span>
        </div>

        <p-table
          styleClass="table-light"
          [value]="pendingActivityItems()"
          [loading]="loadingAgenda()"
          [paginator]="pendingActivityItems().length > 10"
          [rows]="10"
          responsiveLayout="scroll"
          size="small"
        >
          <ng-template pTemplate="header">
            <tr>
              <th>Título</th>
              <th>Origem</th>
              <th>Data</th>
              <th>Status</th>
              <th>Ações</th>
            </tr>
          </ng-template>

          <ng-template pTemplate="body" let-item>
            <tr>
              <td>{{ item.title }}</td>
              <td>{{ item.origin }}</td>
              <td>{{ item.start_at | date: "dd/MM/yyyy HH:mm" }}</td>
              <td>
                <p-tag
                  [value]="statusLabel(item.status)"
                  [severity]="statusSeverity(item.status)"
                ></p-tag>
              </td>
              <td>
                <div class="row-actions">
                  <button
                    pButton
                    type="button"
                    size="small"
                    severity="success"
                    [disabled]="
                      !canManageAgenda()
                      || item.status !== 'OPEN'
                      || handlingReminderAction()
                    "
                    (click)="confirmAgenda(item)"
                  >
                    Confirmar
                  </button>
                  <button
                    pButton
                    type="button"
                    size="small"
                    severity="danger"
                    [disabled]="
                      !canManageAgenda()
                      || (item.status !== 'OPEN' && item.status !== 'CONFIRMED')
                      || handlingReminderAction()
                    "
                    (click)="cancelAgenda(item)"
                  >
                    Cancelar
                  </button>
                </div>
              </td>
            </tr>
          </ng-template>

          <ng-template pTemplate="emptymessage">
            <tr>
              <td colspan="5" class="empty-row">Nenhuma atividade pendente no período.</td>
            </tr>
          </ng-template>
        </p-table>
      </p-card>
    </ng-container>
  </ng-template>
</section>

<p-dialog
  header="Compromisso em 30 minutos"
  [modal]="true"
  [visible]="reminderDialogVisible()"
  [closable]="false"
  [draggable]="false"
  [resizable]="false"
  [style]="{ width: '30rem' }"
>
  <ng-container *ngIf="reminderInFocus() as reminder">
    <div class="reminder-content">
      <p><strong>{{ reminder.title }}</strong></p>
      <p>{{ reminder.start_at | date: "dd/MM/yyyy 'às' HH:mm" }}</p>
      <p class="muted" *ngIf="reminder.subject">{{ reminder.subject }}</p>
    </div>

    <div class="reminder-actions">
      <button
        pButton
        type="button"
        severity="success"
        [disabled]="handlingReminderAction()"
        (click)="handleReminderConfirm()"
      >
        Confirmar
      </button>
      <button
        pButton
        type="button"
        severity="danger"
        [disabled]="handlingReminderAction()"
        (click)="handleReminderCancel()"
      >
        Cancelar
      </button>
    </div>
  </ng-container>
</p-dialog>
