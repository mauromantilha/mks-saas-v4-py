<section class="dashboard-wrap">
  <header class="hero">
    <div>
      <p class="badge">Portal Tenant</p>
      <h1>Painel do Tenant</h1>
      <p class="subtitle">
        Produção, comissão, metas, funil e alertas operacionais consolidados.
      </p>
    </div>
    <div class="hero-actions">
      <a class="ghost" routerLink="/sales/flow">Abrir Fluxo Comercial</a>
      <button
        pButton
        type="button"
        (click)="generateWeeklyActionPlan()"
        [disabled]="loading() || aiLoading()"
      >
        {{ aiLoading() ? "Gerando plano..." : "Plano Semanal IA" }}
      </button>
      <button pButton type="button" (click)="load()" [disabled]="loading()">Atualizar</button>
    </div>
  </header>

  <div *ngIf="session() as s" class="meta">
    <span><strong>Tenant:</strong> {{ s.tenantCode }}</span>
    <span><strong>Usuário:</strong> {{ s.username }}</span>
    <span><strong>Role:</strong> {{ s.role || "-" }}</span>
  </div>

  <p *ngIf="loading()" class="muted">Carregando...</p>
  <p *ngIf="error()" class="error">{{ error() }}</p>
  <p *ngIf="aiError()" class="error">{{ aiError() }}</p>
  <p *ngIf="notice()" class="notice">{{ notice() }}</p>

  <ng-container *ngIf="summary() as summary">
    <section class="kpi-grid">
      <p-card styleClass="kpi kpi-strong">
        <span class="label">Produção (Ano)</span>
        <strong class="value">{{ formatCurrency(summary.kpis.production_premium_ytd) }}</strong>
        <span class="hint">
          Meta: {{ formatCurrency(summary.goals.premium_goal_ytd) }} ({{
            summary.progress.premium_ytd_pct
          }}%)
        </span>
      </p-card>

      <p-card styleClass="kpi kpi-strong">
        <span class="label">Comissão (Ano)</span>
        <strong class="value">{{ formatCurrency(summary.kpis.commission_ytd) }}</strong>
        <span class="hint">
          Meta: {{ formatCurrency(summary.goals.commission_goal_ytd) }} ({{
            summary.progress.commission_ytd_pct
          }}%)
        </span>
      </p-card>

      <p-card styleClass="kpi">
        <span class="label">Produção (Mês)</span>
        <strong class="value">{{ formatCurrency(summary.kpis.production_premium_mtd) }}</strong>
        <span class="hint">
          Meta: {{ formatCurrency(summary.goals.premium_goal_mtd) }} ({{
            summary.progress.premium_mtd_pct
          }}%)
        </span>
      </p-card>

      <p-card styleClass="kpi">
        <span class="label">Comissão (Mês)</span>
        <strong class="value">{{ formatCurrency(summary.kpis.commission_mtd) }}</strong>
        <span class="hint">
          Meta: {{ formatCurrency(summary.goals.commission_goal_mtd) }} ({{
            summary.progress.commission_mtd_pct
          }}%)
        </span>
      </p-card>

      <p-card styleClass="kpi">
        <span class="label">Renovações (30 dias)</span>
        <strong class="value">{{ summary.kpis.renewals_due_next_30d }}</strong>
        <span class="hint">Apólices com vencimento próximo</span>
      </p-card>

      <p-card styleClass="kpi">
        <span class="label">Renovações (Mês)</span>
        <strong class="value">{{ summary.kpis.renewals_mtd }}</strong>
        <span class="hint">Endossos do tipo renovação</span>
      </p-card>

      <p-card styleClass="kpi">
        <span class="label">Clientes</span>
        <strong class="value">{{ summary.kpis.customers_total }}</strong>
        <span class="hint">Lifecycle stage = CUSTOMER</span>
      </p-card>

      <p-card styleClass="kpi">
        <span class="label">Inadimplência</span>
        <strong class="value">{{ formatCurrency(summary.kpis.delinquency_open_total) }}</strong>
        <span class="hint">Preparado para integrar parcelas/recebíveis</span>
      </p-card>
    </section>

    <section class="grid">
      <p-card styleClass="card">
        <h2>Realizado vs Meta</h2>

        <div class="progress-block">
          <div class="progress-row">
            <span class="progress-label">Produção (Mês)</span>
            <span class="progress-value">{{ summary.progress.premium_mtd_pct }}%</span>
          </div>
          <div class="progress-bar">
            <div class="fill" [style.width.%]="clampPct(summary.progress.premium_mtd_pct)"></div>
          </div>
        </div>

        <div class="progress-block">
          <div class="progress-row">
            <span class="progress-label">Comissão (Mês)</span>
            <span class="progress-value">{{ summary.progress.commission_mtd_pct }}%</span>
          </div>
          <div class="progress-bar">
            <div
              class="fill"
              [style.width.%]="clampPct(summary.progress.commission_mtd_pct)"
            ></div>
          </div>
        </div>

        <div class="progress-block">
          <div class="progress-row">
            <span class="progress-label">Produção (Ano)</span>
            <span class="progress-value">{{ summary.progress.premium_ytd_pct }}%</span>
          </div>
          <div class="progress-bar">
            <div class="fill" [style.width.%]="clampPct(summary.progress.premium_ytd_pct)"></div>
          </div>
        </div>

        <div class="progress-block">
          <div class="progress-row">
            <span class="progress-label">Comissão (Ano)</span>
            <span class="progress-value">{{ summary.progress.commission_ytd_pct }}%</span>
          </div>
          <div class="progress-bar">
            <div
              class="fill"
              [style.width.%]="clampPct(summary.progress.commission_ytd_pct)"
            ></div>
          </div>
        </div>
      </p-card>

      <p-card styleClass="card" *ngIf="metrics() as metrics">
        <h2>Funil e SLA</h2>
        <div class="mini-grid">
          <div class="mini-item">
            <span class="mini-label">Leads novos</span>
            <strong class="mini-value">{{ metrics.lead_funnel.NEW }}</strong>
          </div>
          <div class="mini-item">
            <span class="mini-label">Leads qualificados</span>
            <strong class="mini-value">{{ metrics.lead_funnel.QUALIFIED }}</strong>
          </div>
          <div class="mini-item">
            <span class="mini-label">Leads convertidos</span>
            <strong class="mini-value">{{ metrics.lead_funnel.CONVERTED }}</strong>
          </div>
          <div class="mini-item">
            <span class="mini-label">Oportunidades ganhas</span>
            <strong class="mini-value">{{ metrics.opportunity_funnel.WON }}</strong>
          </div>
          <div class="mini-item">
            <span class="mini-label">Atividades em aberto</span>
            <strong class="mini-value">{{ metrics.activities.open_total }}</strong>
          </div>
          <div class="mini-item">
            <span class="mini-label">Atrasadas</span>
            <strong class="mini-value">{{ metrics.activities.overdue_total }}</strong>
          </div>
          <div class="mini-item">
            <span class="mini-label">SLA estourado</span>
            <strong class="mini-value">{{ metrics.activities.sla_breached_total }}</strong>
          </div>
          <div class="mini-item">
            <span class="mini-label">Pipeline aberto</span>
            <strong class="mini-value">
              {{ formatCurrency(metrics.pipeline_value.open_total_amount) }}
            </strong>
          </div>
        </div>
      </p-card>

      <p-card styleClass="card" *ngIf="aiInsights() as ai">
        <h2>IA Insights Automáticos</h2>
        <p class="muted">{{ ai.insights.summary || "Sem resumo de IA." }}</p>
        <div class="mini-grid">
          <div class="mini-item">
            <span class="mini-label">Período</span>
            <strong class="mini-value">{{ ai.period_days }} dias</strong>
          </div>
          <div class="mini-item">
            <span class="mini-label">Provider</span>
            <strong class="mini-value">{{ ai.insights.provider || "-" }}</strong>
          </div>
          <div class="mini-item">
            <span class="mini-label">Score</span>
            <strong class="mini-value">{{ ai.insights.qualification_score ?? "-" }}</strong>
          </div>
        </div>
        <h3>Riscos</h3>
        <ul>
          <li *ngFor="let risk of ai.insights.risks">{{ risk }}</li>
        </ul>
        <h3>Oportunidades</h3>
        <ul>
          <li *ngFor="let item of ai.insights.opportunities">{{ item }}</li>
        </ul>
        <h3>Plano de ação</h3>
        <ol>
          <li *ngFor="let action of ai.insights.next_actions">{{ action }}</li>
        </ol>
      </p-card>

      <p-card styleClass="card" *ngIf="canWrite()">
        <h2>Metas do mês</h2>
        <p class="muted">
          Ajuste as metas de produção/comissão. O painel recalcula o progresso automaticamente.
        </p>

        <div class="form-grid">
          <label>
            Meta produção (prêmio)
            <input
              pInputText
              inputmode="decimal"
              [ngModel]="goalPremium()"
              (ngModelChange)="goalPremium.set(($event ?? '') + '')"
              [disabled]="loading()"
            />
          </label>
          <label>
            Meta comissão
            <input
              pInputText
              inputmode="decimal"
              [ngModel]="goalCommission()"
              (ngModelChange)="goalCommission.set(($event ?? '') + '')"
              [disabled]="loading()"
            />
          </label>
          <label>
            Meta novos clientes
            <input
              pInputText
              inputmode="numeric"
              min="0"
              [ngModel]="goalNewCustomers()"
              (ngModelChange)="goalNewCustomers.set(($event ?? '') + '')"
              [disabled]="loading()"
            />
          </label>
          <label class="field-full">
            Observações
            <textarea
              pInputTextarea
              rows="2"
              [ngModel]="goalNotes()"
              (ngModelChange)="goalNotes.set(($event ?? '') + '')"
              [disabled]="loading()"
            ></textarea>
          </label>
        </div>

        <div class="hero-actions">
          <button pButton type="button" (click)="saveGoals()" [disabled]="loading()">
            Salvar metas
          </button>
        </div>
      </p-card>
    </section>

    <section class="grid wide">
      <p-card styleClass="card">
        <h2>Produção diária (Mês)</h2>
        <div class="bars">
          <div
            *ngFor="let p of dailySeries()"
            class="bar"
            [style.height.%]="barHeight(p.premium_total, dailyMaxPremium())"
            [title]="p.date + ' | ' + formatCurrency(p.premium_total)"
          ></div>
        </div>
        <p class="muted">Barras representam o prêmio total por dia (endossos).</p>
        <p-table [value]="dailySeries()" class="series-table top-gap" [paginator]="false" responsiveLayout="scroll">
          <ng-template pTemplate="header">
            <tr>
              <th>Data</th>
              <th>Prêmio</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-row>
            <tr>
              <td>{{ row.date }}</td>
              <td>{{ formatCurrency(row.premium_total) }}</td>
            </tr>
          </ng-template>
        </p-table>
      </p-card>

      <p-card styleClass="card">
        <h2>Produção mensal (Ano)</h2>
        <div class="bars month-bars">
          <div
            *ngFor="let p of monthlySeries()"
            class="bar"
            [style.height.%]="barHeight(p.premium_total, monthlyMaxPremium())"
            [title]="'Mês ' + p.month + ' | ' + formatCurrency(p.premium_total)"
          ></div>
        </div>
        <p class="muted">Barras representam o prêmio total por mês (YTD).</p>
        <p-table [value]="monthlySeries()" class="series-table top-gap" [paginator]="false" responsiveLayout="scroll">
          <ng-template pTemplate="header">
            <tr>
              <th>Mês</th>
              <th>Prêmio</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-row>
            <tr>
              <td>{{ row.month }}</td>
              <td>{{ formatCurrency(row.premium_total) }}</td>
            </tr>
          </ng-template>
        </p-table>
      </p-card>
    </section>
  </ng-container>
</section>
