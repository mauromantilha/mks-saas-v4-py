<p-toast position="top-right"></p-toast>

<section class="advisor-page advisor-aura-light">
  <header class="advisor-header">
    <div class="title-wrap">
      <p class="eyebrow">Estratégia & Comercial</p>
      <h1>MKS Advisor</h1>
      <p class="subtitle">
        Faça uma pergunta única para internet e sistema interno. Ex.: como está a inadimplência essa semana?
      </p>
    </div>
  </header>

  <ng-container *ngIf="permissionsLoading(); else permissionsReady">
    <section class="state-grid">
      <p-card styleClass="state-card">
        <p-skeleton width="100%" height="14rem"></p-skeleton>
      </p-card>
      <p-card styleClass="state-card">
        <p-skeleton width="100%" height="12rem"></p-skeleton>
      </p-card>
    </section>
  </ng-container>

  <ng-template #permissionsReady>
    <p-card *ngIf="!canUseAI()" styleClass="state-card state-error">
      <h2>Acesso bloqueado</h2>
      <p>Seu usuário não possui a capability <code>tenant.ai.use</code> para usar o MKS Advisor.</p>
      <p *ngIf="permissionError()" class="muted">{{ permissionError() }}</p>
    </p-card>

    <ng-container *ngIf="canUseAI()">
      <p-card *ngIf="error()" styleClass="state-card state-error">
        <h2>Falha no MKS Advisor</h2>
        <p>{{ error() }}</p>
      </p-card>

      <p-card styleClass="panel-card prompt-card tone-blue">
        <div class="panel-head">
          <h2>Prompt único</h2>
          <div class="prompt-actions">
            <button
              pButton
              type="button"
              class="btn-secondary"
              [disabled]="consulting() || !prompt().trim()"
              (click)="clearPrompt()"
            >
              Limpar
            </button>
            <button
              pButton
              type="button"
              class="btn-primary"
              [disabled]="consulting() || !prompt().trim()"
              (click)="sendPrompt()"
            >
              {{ consulting() ? "Consultando..." : "Consultar" }}
            </button>
          </div>
        </div>

        <textarea
          pInputTextarea
          rows="4"
          [ngModel]="prompt()"
          (ngModelChange)="prompt.set(($event ?? '').toString())"
          [disabled]="consulting()"
          placeholder="Ex.: como está a inadimplência essa semana considerando internet e dados do sistema?"
        ></textarea>

        <div class="answer-wrap" *ngIf="consulting()">
          <p-skeleton width="100%" height="6rem"></p-skeleton>
        </div>

        <div class="answer-wrap" *ngIf="!consulting() && answer()">
          <h3>Resposta do MKS Advisor</h3>
          <p>{{ answer() }}</p>
        </div>
      </p-card>

      <p-card styleClass="panel-card advisor-feed-card tone-green">
        <div class="panel-head panel-head--compact">
          <div>
            <h2>Advisor em análise contínua</h2>
            <p class="muted small">{{ suggestionsUpdatedLabel() }}</p>
          </div>
          <button pButton type="button" class="btn-secondary" [disabled]="loadingSuggestions()" (click)="refreshSuggestions()">
            {{ loadingSuggestions() ? "Atualizando..." : "Atualizar" }}
          </button>
        </div>

        <div class="analysis-pills">
          <p-tag
            *ngFor="let row of analysisPills"
            [value]="row.label"
            [severity]="row.tone"
          ></p-tag>
        </div>

        <ng-container *ngIf="loadingSuggestions() && advisorFeed().length === 0">
          <div class="suggestion-skeletons">
            <p-skeleton width="100%" height="3.8rem"></p-skeleton>
            <p-skeleton width="100%" height="3.8rem"></p-skeleton>
            <p-skeleton width="100%" height="3.8rem"></p-skeleton>
          </div>
        </ng-container>

        <div class="advisor-feed" *ngIf="advisorFeed().length > 0">
          <article
            class="advisor-item"
            [ngClass]="item.tone"
            *ngFor="let item of advisorFeed(); trackBy: trackByFeedId"
          >
            <div class="advisor-item-head">
              <h3>{{ item.title }}</h3>
              <p-chip [label]="item.scope"></p-chip>
            </div>
            <p>{{ item.body }}</p>
          </article>
        </div>
      </p-card>
    </ng-container>
  </ng-template>
</section>
